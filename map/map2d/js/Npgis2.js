MapPlatForm={},MapPlatForm.Base={},MapPlatForm.ModdleMarker=0,MapPlatForm.BottomMarker=1,MapPlatForm.CustomMarker=2,MapPlatForm.VERSIONNUMBER="v1.7.4",function(){MapPlatForm.Base.MapConfig=function(){this.CLASS_NAME="MapConfig",this.dataServiceURL="/npgisdataservice/",this.mapServiceURL="",this.mapInfo=null,this._mapJson=null},MapPlatForm.Base.MapConfig.prototype._addLayerToMap=function(t,e){var a=[];if(e&&e.length>0){for(var i,r,o,s=0,n=e.length;s<n;s++)i=e[s],o=i.layerType.split("."),r=new NPMapLib.Layers[o[o.length-1]](i.layerOpt.url,i.layerName,i.layerOpt),a.push(r);t.addLayers(a)}return a},MapPlatForm.Base.MapConfig.prototype.createMap=function(t,e){this.mapInfo=e;for(var a=new NPMapLib.Map(t,e.mapOpts),i=this._addLayerToMap(a,e.vectorLayer),r=this._addLayerToMap(a,e.sattilateLayer),o=r.length-1;o>=0;o--)r[o].hide();return this._mapJson={map:a,vectorLayer:i,sattilateLayer:r},this.showVectorLayer(),this._mapJson},MapPlatForm.Base.MapConfig.prototype.showVectorLayer=function(){if(this._mapJson&&this._mapJson.vectorLayer){if(this._mapJson.vectorLayer.length>1)for(var t=0;t<this._mapJson.vectorLayer.length;t++)this._mapJson.vectorLayer[t].show(),this._mapJson.vectorLayer[t].setZIndex(this._mapJson.vectorLayer[0].getZIndex()+t+1);if(this._mapJson.sattilateLayer.length>1)for(var t=this._mapJson.sattilateLayer.length-1;t>=1;t--)this._mapJson.sattilateLayer[t].hide();this._mapJson.vectorLayer.length>0&&this._mapJson.map.setBaseLayer(this._mapJson.vectorLayer[0])}},MapPlatForm.Base.MapConfig.prototype.showSattilateLayer=function(){if(this._mapJson&&this._mapJson.sattilateLayer){if(this._mapJson.sattilateLayer.length>1)for(var t=this._mapJson.sattilateLayer.length-1;t>=1;t--)this._mapJson.sattilateLayer[t].show(),this._mapJson.sattilateLayer[t].setZIndex(this._mapJson.sattilateLayer[0].getZIndex()+t+1);if(this._mapJson.vectorLayer.length>1)for(var t=this._mapJson.vectorLayer.length-1;t>=1;t--)this._mapJson.vectorLayer[t].hide();this._mapJson.sattilateLayer.length>0&&this._mapJson.map.setBaseLayer(this._mapJson.sattilateLayer[0])}}}(),function(t,e){"use strict";var a=function(t){this._init(t),this._initCanvas()};a.prototype.drawLines=function(t){if(t){var e,a,i,r,o=0,s=t.length;for(this._data=new Array(s),this._pointsOnLines=[],o;o<s;o++)e=t[o],a=e.geometry.coordinates,i=this._adjustmentOfStyle(e.style),r=this._dataConversion([a],i.degree,i.lineCurve),this._data[o]={geometry:{coordinates:r},style:i};this._reDrawLines(),this._animatePoint()}},a.prototype.enableFlow=function(){if(this._animatePointFlag=!0,this._pointsOnLines&&0===this._pointsOnLines.length){var t,e,a=0,i=this._data.length;for(a;a<i;a++)t=this._data[a].geometry.coordinates[0],e=this._data[a].style,this._getPointsOnLines(e.lineCurve,t)}this._animatePoint()},a.prototype.disableFlow=function(){this._animatePointFlag=!1,this._anictx.clearRect(0,0,this._anictx.canvas.width,this._anictx.canvas.height)},a.prototype.remove=function(){this._clearDrawLines(),this._anictx.clearRect(0,0,this._anictx.canvas.width,this._anictx.canvas.height),t.cancelAnimationFrame(this._animatePointHandler),this._animatePointHandler=null,this._data=null,this._pointsOnLines=null},a.prototype.destroy=function(){this.remove(),this._baseMask.removeFromMap(),this._animateMask.removeFromMap(),this._endPointMask.removeFromMap(),this._removeMapEventFlag=!0},a.prototype._dataConversion=function(t,e,a){var i,r,o=0,s=t.length,n=new Array(s);for(o;o<s;o++)i=t[o],r=a?this._createShapePointsForCurve(i,e):this._createShapePoints(i),n[o]=r,this._animatePointFlag&&this._getPointsOnLines(a,r);return n},a.prototype._getPointsOnLines=function(t,e){t?this._pointsOnLines.push(this._getPointsOnCurve(e)):this._pointsOnLines.push(this._getPointsOnLine(e)),this._aniIndex.push(0)},a.prototype._adjustmentOfStyle=function(t){var a=t&&t.line||{},i=t&&t.startPoint||{},r=t&&t.endPoint||{},o=!0,s=!0,n=!0;a.curve||a.curve===e||(o=a.curve),i.show||i.show===e||(s=i.show),r.show||r.show===e||(n=r.show);var l={startPointSize:i.size||4,startPointColor:i.color||"rgba(255,0,0,1)",startPointShow:s,endPointSize:r.size||4,endPointColor:r.color||"rgba(255,0,0,1)",endPointShow:n,lineColor:a.color||"rgba(255,0,0,1)",lineFillColor:a.fillColor||"rgba(255,0,0,1)",lineWidth:a.width||1,lineCurve:o,degree:a.degree||MAPPLATFORM_BASE_CURVE_ANIM_30};return this._flowColor=a.flowColor||"rgba(255,255,255,1)",this._flowSize=a.flowSize||2,l},a.prototype._doDrawLines=function(t,e){var a,i,r,o,s=t.length;for(this._ctx.beginPath(),this._setLineStyle(e),a=0;a<s;a++)i=t[a],r=i[0],o=this._trafficUtil.mercatorToPixel([r.lon,r.lat],this._ctx),this._ctx.moveTo(~~(.5+o.x),~~(.5+o.y)),e.lineCurve?this._doDrawCurve(i):this._doDrawLine(i),this._drawEndpoints(e,o,i);this._ctx.stroke(),this._endPointctx.stroke()},a.prototype._doDrawLine=function(t){var e,a,i=1,r=t.length;for(i;i<r;i++)e=t[i],a=this._trafficUtil.mercatorToPixel([e.lon,e.lat],this._ctx),this._ctx.lineTo(~~(.5+a.x),~~(.5+a.y))},a.prototype._doDrawCurve=function(t){var e=t[1],a=t[2],i=this._trafficUtil.mercatorToPixel([e.lon,e.lat],this._ctx),r=this._trafficUtil.mercatorToPixel([a.lon,a.lat],this._ctx);this._ctx.quadraticCurveTo(~~(.5+i.x),~~(.5+i.y),~~(.5+r.x),~~(.5+r.y))},a.prototype._drawEndpoints=function(t,e,a){var i,r;t.startPointShow&&this._drawEndpoint(e,t,"s"),t.endPointShow&&(i=a[a.length-1],r=this._trafficUtil.mercatorToPixel([i.lon,i.lat],this._ctx),this._drawEndpoint(r,t,"e"))},a.prototype._drawEndpoint=function(t,e,a){var i=4;"s"===a?(i=e.startPointSize,this._endPointctx.fillStyle=e.startPointColor,this._endPointctx.strokeStyle=e.startPointColor):(i=e.endPointSize,this._endPointctx.fillStyle=e.endPointColor,this._endPointctx.strokeStyle=e.endPointColor),this._endPointctx.beginPath(),this._endPointctx.arc(~~(.5+t.x),~~(.5+t.y),i/2,0,2*Math.PI,!0),this._endPointctx.closePath(),this._endPointctx.fill()},a.prototype._getPointsOnCurve=function(t){var e,a,i,r=[];for(e=0;e<=1;e+=.025)a=(1-e)*(1-e)*t[0].lon+2*(1-e)*e*t[1].lon+e*e*t[2].lon,i=(1-e)*(1-e)*t[0].lat+2*(1-e)*e*t[1].lat+e*e*t[2].lat,r.push([a,i]);return r},a.prototype._getPointsOnLine=function(t){var e=0,a=t.length,i=new Array(a);for(e;e<a;e++)i[e]=[t[e].lon,t[e].lat];return i},a.prototype._setLineStyle=function(t){this._ctx.strokeStyle=t.lineColor,this._ctx.fillStyle=t.lineFillColor,this._ctx.lineWidth=t.lineWidth},a.prototype._animatePoint=function(){if(this._animatePointFlag){var t,e,a,i,r,o=this._pointsOnLines&&this._pointsOnLines.length||0;for(this._anictx.clearRect(0,0,this._anictx.canvas.width,this._anictx.canvas.height),this._anictx.fillStyle=this._flowColor,t=0;t<o;t++)e=this._pointsOnLines[t],a=this._aniIndex[t],i=e[a],r=this._trafficUtil.mercatorToPixel(i,this._anictx),this._anictx.fillRect(r.x-1,r.y-1,this._flowSize,this._flowSize),this._aniIndex[t]++,this._aniIndex[t]>=e.length&&(this._aniIndex[t]=0);this._cycleAnimatePoint()}},a.prototype._cycleAnimatePoint=function(){var e=this;setTimeout(function(){e._animatePointHandler=t.requestAnimationFrame(function(){e._animatePoint()})},200)},a.prototype._init=function(t){this._initRaf(),this._npMap=t,this._olMap=t._mapAdapter.map,this._trafficUtil=new MapPlatForm.Base.TrafficUtil(t),this._animatePointHandler=0,this._data,this._pointsOnLines,this._aniIndex=[],this._animatePointFlag=!0,this._flowColor,this._flowSize,this._removeMapEventFlag=!1,this._bind()},a.prototype._initRaf=function(){for(var e=0,a=["webkit","moz"],i=0;i<a.length&&!t.requestAnimationFrame;++i)t.requestAnimationFrame=t[a[i]+"RequestAnimationFrame"],t.cancelAnimationFrame=t[a[i]+"CancelAnimationFrame"]||t[a[i]+"CancelRequestAnimationFrame"];t.requestAnimationFrame||(t.requestAnimationFrame=function(a,i){var r=(new Date).getTime(),o=Math.max(0,16-(r-e)),s=t.setTimeout(function(){a(r+o)},o);return e=r+o,s}),t.cancelAnimationFrame||(t.cancelAnimationFrame=function(t){clearTimeout(t)})},a.prototype._initCanvas=function(){this._baseMask=new MapPlatForm.Base.MapMask(this._npMap),this._ctx=this._baseMask.getContext(),this._ctx.translate(.5,.5),this._animateMask=new MapPlatForm.Base.MapMask(this._npMap),this._anictx=this._animateMask.getContext(),this._endPointMask=new MapPlatForm.Base.MapMask(this._npMap),this._endPointctx=this._endPointMask.getContext(),this._solveZoomLost()},a.prototype._solveZoomLost=function(){var t=this._trafficUtil.getBrowserType();if("IE"===t){var e=this;this._endPointctx.canvas.addEventListener("mousewheel",function(t){e._npMap._mapAdapter._navigator.handlers.wheel.onWheelEvent(t,!0)},!1)}},a.prototype._bind=function(){var t=this;this._npMap.addEventListener("movestart",function e(){t._clearDrawLines(),t._removeMapEventFlag&&t._npMap.removeEventListener("movestart",e)}),this._npMap.addEventListener("moveend",function a(){t._resizeCanvas(),t._reDrawLines(),t._removeMapEventFlag&&t._npMap.removeEventListener("moveend",a)}),this._npMap.addEventListener(NPMapLib.MAP_EVENT_ZOOM_START,function i(){t._clearDrawLines(),t._removeMapEventFlag&&t._npMap.removeEventListener("zoomstart",i)})},a.prototype._clearDrawLines=function(){this._ctx.clearRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height),this._endPointctx.clearRect(0,0,this._endPointctx.canvas.width,this._endPointctx.canvas.height)},a.prototype._resizeCanvas=function(){var t=this._npMap.getSize();this._ctx.canvas.width=t.width,this._ctx.canvas.height=t.height,this._endPointctx.canvas.width=t.width,this._endPointctx.canvas.height=t.height,this._anictx.canvas.width=t.width,this._anictx.canvas.height=t.height},a.prototype._reDrawLines=function(){if(this._data){var t,e,a,i=0,r=this._data.length;for(i;i<r;i++)t=this._data[i],e=t.geometry.coordinates,a=t.style,this._doDrawLines(e,a)}},a.prototype._createShapePoints=function(t,e){var a,i=0,r=t.length,o=new Array(r);for(i;i<r;i++)a=this._trafficUtil.wgs84ToMercator(t[i]),o[i]=a;return o},a.prototype._createShapePointsForCurve=function(t,e){var a=new Array(3),i=t.length,r=this._trafficUtil.wgs84ToMercator(t[0]),o=this._trafficUtil.wgs84ToMercator(t[i-1]),s=this._createControlPoint(r,o,e);return a[0]=r,a[1]=s,a[2]=o,a},a.prototype._createControlPoint=function(t,e,a){var i=t.lon,r=t.lat,o=e.lon,s=e.lat,n=(i+o)/2,l=(r+s)/2,h=(r-s)*a+n,p=(o-i)*a+l;return{lon:h,lat:p}},t.MapPlatForm.Base.MapCurve=a}(window),function(t,e){"use strict";var a=function(t){this._npMap=t,this._olMap=t._mapAdapter.map};a.prototype.wgs84ToMercator=function(t){return NPMap.T.setPoint(this._npMap,new NPMapLib.Geometry.Point(t[0],t[1]))},a.prototype.mercatorToPixel=function(t,e){var a=this.getRes(),i=this._olMap.getCenter(),r=new NPMapLib.Geometry.Pixel(i.lon-e.canvas.width/2*a,i.lat+e.canvas.height/2*a),o=(t[0]-r.x)/a,s=(r.y-t[1])/a;return{x:o,y:s}},a.prototype.getRes=function(){var t=this._olMap.getZoom();return this._olMap.getResolutionForZoom(t)},a.prototype.getBrowserType=function(){var t=navigator.userAgent,e=t.indexOf("Opera")>-1;return e?"Opera":t.indexOf("Firefox")>-1?"FF":t.indexOf("Chrome")>-1?"Chrome":t.indexOf("Safari")>-1?"Safari":t.indexOf("compatible")>-1&&t.indexOf("MSIE")>-1&&!e?"IE":void 0},t.MapPlatForm.Base.TrafficUtil=a}(window),function(t,e){"use strict";var a=function(t){this._npMap=t,this._olMap=t._mapAdapter.map,this._canvas,this._addToMap()};a.prototype._addToMap=function(){this._canvas=this._createMapMask(),this._olMap.viewPortDiv.appendChild(this._canvas)},a.prototype._createMapMask=function(){var t=document.createElement("canvas"),e=this._npMap.getSize();return t.width=e.width,t.height=e.height,t.style.cssText="position:absolute;left:0;top:0;width:100%;height:100%;z-index:999;",t.style.pointerEvents="none",t},a.prototype.getCanvas=function(){return this._canvas},a.prototype.getContext=function(){return this._canvas.getContext?this._canvas.getContext("2d"):void alert("浏览器不支持 canvas!")},a.prototype.removeFromMap=function(){this._olMap.viewPortDiv.removeChild(this._canvas)},t.MapPlatForm.Base.MapMask=a}(window),MAPPLATFORM_BASE_CURVE_15=.1,MAPPLATFORM_BASE_CURVE_30=.2,MAPPLATFORM_BASE_CURVE_45=.3,MAPPLATFORM_BASE_CURVE_60=.4,MAPPLATFORM_BASE_CURVE_75=.5,MAPPLATFORM_BASE_CURVE_95=.6,MAPPLATFORM_BASE_CURVE_105=.7,MAPPLATFORM_BASE_CURVE_REVERSE_15=-.1,MAPPLATFORM_BASE_CURVE_REVERSE_30=-.2,MAPPLATFORM_BASE_CURVE_REVERSE_45=-.3,MAPPLATFORM_BASE_CURVE_REVERSE_60=-.4,MAPPLATFORM_BASE_CURVE_REVERSE_75=-.5,MAPPLATFORM_BASE_CURVE_REVERSE_95=-.6,MAPPLATFORM_BASE_CURVE_REVERSE_105=-.7,function(){MapPlatForm.Base.MapGeometry=function(t){this.CLASS_NAME="MapPlatForm.Base.MapGeometry",this.map=t},MapPlatForm.Base.MapGeometry.prototype.getGeometryByGeoJson=function(t){var e=GeoJSON.read(t);return e},MapPlatForm.Base.MapGeometry.prototype.getGeometryByWKT=function(t){var e=WKT.read(t);return e},MapPlatForm.Base.MapGeometry.prototype.getFGeoJsonByGeometry=function(t){var e=GeoJSON.write(t,this.map);return e},MapPlatForm.Base.MapGeometry.prototype.getGGeoJsonByGeometry=function(t){var e=GeoJSON.write(t,this.map),a=JSON.parse(e),t=JSON.stringify(a.geometry);return t},MapPlatForm.Base.MapGeometry.prototype.getWKTByGeometry=function(t){var e=WKT.write(t,this.map);return e},MapPlatForm.Base.MapGeometry.prototype.getExtent2Polygon=function(t){var e=[];e.push(new NPMapLib.Geometry.Point(t.sw.lon,t.sw.lat)),e.push(new NPMapLib.Geometry.Point(t.ne.lon,t.sw.lat)),e.push(new NPMapLib.Geometry.Point(t.ne.lon,t.ne.lat)),e.push(new NPMapLib.Geometry.Point(t.sw.lon,t.ne.lat)),e.push(new NPMapLib.Geometry.Point(t.sw.lon,t.sw.lat));var a=new NPMapLib.Geometry.Polygon(e);return a},MapPlatForm.Base.MapGeometry.prototype.createMarker=function(t,e){markerType=e.markerType?e.markerType:MapPlatForm.ModdleMarker;var a=new NPMapLib.Symbols.Icon(e.url,new NPMapLib.Geometry.Size(e.size.width,e.size.height));markerType===MapPlatForm.ModdleMarker&&a.setAnchor(new NPMapLib.Geometry.Size(-e.size.width/2,-e.size.height/2)),markerType==MapPlatForm.CustomMarker&&a.setAnchor(new NPMapLib.Geometry.Size((-e.iconOffset.width),(-e.iconOffset.height)));var i=new NPMapLib.Symbols.Marker(t);if(i.setIcon(a),e.text){label=new NPMapLib.Symbols.Label(e.text),label.setStyle({Color:"#ffffff"}),e.labelOffset=e.labelOffset?e.labelOffset:{width:0,height:0};var r=new NPMapLib.Geometry.Size(e.labelOffset.width,e.labelOffset.height);label.setOffset(r),i.setLabel(label)}return i},MapPlatForm.Base.MapGeometry.prototype.getIconByParam=function(t){markerType=t.markerType?t.markerType:MapPlatForm.ModdleMarker;var e=new NPMapLib.Symbols.Icon(t.url,new NPMapLib.Geometry.Size(t.size.width,t.size.height));return markerType===MapPlatForm.ModdleMarker&&e.setAnchor(new NPMapLib.Geometry.Size(-t.size.width/2,-t.size.height/2)),markerType===MapPlatForm.CustomMarker&&e.setAnchor(new NPMapLib.Geometry.Size((-t.iconOffset.width),(-t.iconOffset.height))),e},MapPlatForm.Base.MapGeometry.prototype.getExtentByOverlays=function(t){for(var e,a,i,r,o=t.length-1;o>=0;o--){var s=t[o].getExtent();e&&a&&i&&r?(e>s.left&&(e=s.left),a>s.bottom&&(a=s.bottom),i<s.right&&(i=s.right),r<s.top&&(r=s.top)):(e=s.left,a=s.bottom,i=s.right,r=s.top)}return new NPMapLib.Geometry.Extent(e,a,i,r)},MapPlatForm.Base.MapGeometry.prototype.sortingResourceByLine=function(t,e,a){a=a||50;for(var i=[],r=this._getLinePoints(e,a),o=this._getShortPointsInLine(t,e),s=0;s<r.length;s++){var n=null;n=s<r.length-1?r[s+1]:new NPMapLib.Geometry.Point(r[s].lon+(r[s].lon-r[s-1].lon)/2,r[s].lat+(r[s].lat-r[s-1].lat)/2);for(var l=this._findShortestMarker(o,r[s],n,a),h=l.length-1;h>=0;h--){for(var p=!1,c=0;c<i.length;c++)i[c]&&i[c].id===l[h].id&&(p=!0);!p&&l[h]&&i.push(l[h])}}for(var s=0;s<t.length;s++){for(var p=!1,c=0;c<i.length;c++)i[c].id===t[s].id&&(p=!0);p||i.push(t[s])}return i},MapPlatForm.Base.MapGeometry.prototype._getLinePoints=function(t,e){for(var a=t.getPath(),i=[],r=0;r<a.length-1;r++){s_points=this._splitPoints(a[r],a[r+1],e);for(var o=0;o<s_points.length;o++)i.push(s_points[o])}return i},MapPlatForm.Base.MapGeometry.prototype._splitPoints=function(t,e,a){var i=[t],r=this.map.getDistance(t,e,"4326"),o=0;a>0&&(o=Math.ceil(r/a));for(var s,n,l=1;l<o;l++){s=l/o;var h=parseFloat((e.lon-t.lon)*s)+parseFloat(t.lon),p=parseFloat((e.lat-t.lat)*s)+parseFloat(t.lat);n=new NPMapLib.Geometry.Point(h,p),i.push(n)}return i},MapPlatForm.Base.MapGeometry.prototype._getShortPointsInLine=function(t,e){for(var a=[],i=0;i<t.length;i++){var r=null;r=t[i].longitude&&t[i].latitude?new NPMapLib.Geometry.Point(t[i].longitude,t[i].latitude):t[i].getPosition();var o=e.getPath(),s=999999,n=null;sline=null;for(var l=0;l<o.length-1;l++){var h=this._getSibgleShortPointInLine(r.lon,r.lat,o[l].lon,o[l].lat,o[l+1].lon,o[l+1].lat),p=this._calculateEuclideanDistance(h.lon,h.lat,r.lon,r.lat);s>p&&(s=p,n=h,sline=new NPMapLib.Geometry.Polyline([o[l],o[l+1]]))}a.push({key:i,shortPoint:n,data:t[i]})}return a},MapPlatForm.Base.MapGeometry.prototype._findShortestMarker=function(t,e,a,i){for(var r=[],o=0;o<t.length;o++){var s=t[o].shortPoint,n=this.map.getDistance(s,e,"4326"),l=this.map.getDistance(s,a,"4326"),h=this.map.getDistance(e,a,"4326");n<i/2&&(l*l>n*n+h*h&&(n=0-n),r.push({distance:n,marker:t[o].data}))}r=r.sort(function(t,e){return t.distance-e.distance});for(var p=[],o=r.length-1;o>=0;o--)p.push(r[o].marker);return p},MapPlatForm.Base.MapGeometry.prototype._getSibgleShortPointInLine=function(t,e,a,i,r,o){var s,n,l;if(s=this._calculateEuclideanDistance(a,i,r,o),n=this._calculateEuclideanDistance(a,i,t,e),l=this._calculateEuclideanDistance(r,o,t,e),s===n+l)return new NPMapLib.Geometry.Point(t,e);if(s<=1e-6)return new NPMapLib.Geometry.Point(a,i);if(l*l>=s*s+n*n)return new NPMapLib.Geometry.Point(a,i);if(n*n>=s*s+l*l)return new NPMapLib.Geometry.Point(r,o);var h=(o-i)/(r-a),p=(t+(e-i)*h+h*h*a)/(h*h+1),c=h*p-h*a+i;return new NPMapLib.Geometry.Point(p,c)},MapPlatForm.Base.MapGeometry.prototype._calculateEuclideanDistance=function(t,e,a,i){var r=Math.sqrt((t-a)*(t-a)+(e-i)*(e-i));return r}}(),function(){MapPlatForm.Base.MapGeometryAnim=function(t){this.CLASS_NAME="MapPlatForm.Base.MapGeometryAnim",this._npMap=t,this._map=t._mapAdapter.map,this._removeMapEventFlag=!1,this._trafficUtil=new MapPlatForm.Base.TrafficUtil(t),this._pointDefaultStyle={startColor:"#FF0000",endColor:"#FF0000",size:20},this._lineDefaultStyle={flowStep:3,flowElementSpace:3.5,flowCount:1,flowElementBgColor:"#FFFF72",flowElementMax:7,flowElementMin:0,flowElementCount:10,lineBorderWidth:5,lineBorderColor:"#FF0000",lineDash:!1,lineDashColor:"#00FF00",lineDashPattern:[16,16],lineDash3d:!1,curve:!1,degree:10},this._graphView=new ht.graph.GraphView,this._dm=this._graphView.dm(),this._view=this._graphView.getView(),this._graphView.setEditable(!0),this._canvas=this._graphView.getCanvas(),this._canvas.width=this._npMap.getSize().width,this._canvas.height=this._npMap.getSize().height,this._ctx=this._canvas.getContext("2d"),this._map.viewPortDiv.appendChild(this._view),this._initFun(),this._curve=!1,this._degree=MAPPLATFORM_BASE_MAPGEOMETRYANIM_30},MapPlatForm.Base.MapGeometryAnim.prototype.createAnimPoint=function(t,e){var a=this._objectExtend(e,this._pointDefaultStyle),i=NPMapLib.T.setPoint(this._npMap,t),r=this._map.getPixelFromLonLat(i),o=new ht.Node;o.s("endColor",a.endColor),o.s("startColor",a.startColor),o.setSize(a.size,a.size),o.setImage("bubble"),o.setPosition(r),o.lonLat=i,this._dm.add(o)},MapPlatForm.Base.MapGeometryAnim.prototype.createAnimLine=function(t,e){var a,i=new ht.Shape,r=this._objectExtend(e,this._lineDefaultStyle),o=r.curve||!1,s=r.degree||MAPPLATFORM_BASE_MAPGEOMETRYANIM_30;o&&(i.setSegments([1,3]),this._curve=o,this._degree=s),a=this._createShapePoints(t),i.setPoints(a),this._createShapeStyle(i,r),this._dm.add(i)},MapPlatForm.Base.MapGeometryAnim.prototype.clear=function(){this._dm.clear()},MapPlatForm.Base.MapGeometryAnim.prototype.hideView=function(){this._graphView._view.style.display="none"},MapPlatForm.Base.MapGeometryAnim.prototype.showView=function(){this._graphView._view.style.display="block"},MapPlatForm.Base.MapGeometryAnim.prototype.enableFlow=function(t){this._graphView.enableFlow(t)},MapPlatForm.Base.MapGeometryAnim.prototype.disableFlow=function(){this._graphView.disableFlow(),this._dm.disableAnimation()},MapPlatForm.Base.MapGeometryAnim.prototype.enablePointAnimation=function(){this._animPoint=!0},MapPlatForm.Base.MapGeometryAnim.prototype.disablePointAnimation=function(){this._animPoint=!1},MapPlatForm.Base.MapGeometryAnim.prototype.destroy=function(){this._map.viewPortDiv.removeChild(this._view),this.disableFlow(),this.disablePointAnimation(),this.clear(),this._trafficUtil=null,this._curve=null,this._degree=null,this._ctx=null,this._canvas=null,this._view=null,this._dm.clear,this._graphView=null,this._removeMapEventFlag=!0},MapPlatForm.Base.MapGeometryAnim.prototype._initFun=function(){this._initHT(),this._initInteractive(),this._setDefaultImg(),this._setDefaultCompType()},MapPlatForm.Base.MapGeometryAnim.prototype._initInteractive=function(){this._map.events.fallThrough=!0;var t=this;this._npMap.addEventListener("movestart",function e(){t._mapOptStartCallback(),t._removeMapEventFlag&&t._npMap.removeEventListener("movestart",e)},{passive:!0}),this._npMap.addEventListener("moveend",function a(){t._mapOptEndCallback(),t._removeMapEventFlag&&t._npMap.removeEventListener("moveend",a)},{passive:!0}),this._npMap.addEventListener("zoomstart",function i(){t._mapOptStartCallback(),t._removeMapEventFlag&&t._npMap.removeEventListener("zoomstart",i)},{passive:!0})},MapPlatForm.Base.MapGeometryAnim.prototype._mapOptStartCallback=function(){this._graphView&&(this._graphView.isVisible=function(t){return!1})},MapPlatForm.Base.MapGeometryAnim.prototype._mapOptEndCallback=function(){this._graphView&&(this._view.style.opacity=1,this._resetPosition(),this._graphView.isVisible=function(t){return!0})},MapPlatForm.Base.MapGeometryAnim.prototype._initHT=function(){this._view.className="olScrollable",this._graphView.disableToolTip(),this._graphView.setScrollBarVisible(!1),this._graphView.setAutoScrollZone(-1),this._graphView.handleScroll=function(){},this._graphView.handlePinch=function(){},this._animPoint=!0,this._graphView.enableFlow(60),this._begin();var t=this._graphView.getSelectionModel();t.setSelectionMode("none"),this._view.style.position="absolute",this._view.style.top="0",this._view.style.left="0",this._view.style.right="0",this._view.style.bottom="0",this._view.style.zIndex=999;var e=this;this._view.addEventListener("ontouchend"in document?"touchstart":"mousedown",function(t){var a=e._graphView.getDataAt(t);(a||t.metaKey||t.ctrlKey)&&t.stopPropagation()},!1)},MapPlatForm.Base.MapGeometryAnim.prototype._resetPosition=function(){this._graphView.tx(0),this._graphView.ty(0);var t=this;this._dm.each(function(e){e instanceof ht.Shape?t._resetShape(e):e instanceof ht.Node&&e.lonLat&&e.setPosition(t._trafficUtil.mercatorToPixel([e.lonLat.lon,e.lonLat.lat],t._ctx))}),this._graphView.validate(),this._view.style.display="block"},MapPlatForm.Base.MapGeometryAnim.prototype._resetShape=function(t){var e,a,i=new ht.List,r=t,o=t.getPoints(),s=0,n=o.size();for(s;s<n;s++)e=o.get(s),e.lonLat&&(a=this._trafficUtil.mercatorToPixel([e.lonLat.lon,e.lonLat.lat],this._ctx),a.lonLat=e.lonLat,i.add(a));r.setPoints(i)},MapPlatForm.Base.MapGeometryAnim.prototype._createShapeStyle=function(t,e){t.s("shape.border.width",e.lineBorderWidth),t.s("shape.border.color",e.lineBorderColor),t.s("shape.background",null),t.s("shape.dash",e.lineDash),t.s("shape.dash.color",e.lineDashColor),t.s("shape.dash.pattern",e.lineDashPattern),t.s("shape.dash.3d",e.lineDash3d),t.s("flow",!0),t.s("flow.step",e.flowStep),t.s("flow.count",e.flowCount),t.s("flow.element.space",e.flowElementSpace),t.s("flow.element.background",e.flowElementBgColor),t.s("flow.element.shadow.visible",!1),t.s("flow.element.max",e.flowElementMax),t.s("flow.element.min",e.flowElementMin),t.s("flow.element.count",e.flowElementCount)},MapPlatForm.Base.MapGeometryAnim.prototype._setDefaultImg=function(){ht.Default.setImage("bubble",{width:{func:function(t){return t._width||40}},height:{func:function(t){return t._height||40}},comps:[{cid:1,type:"bubble-shadow",relative:1,rect:[17,1,1]},{cid:2,type:"bubble-shadow",relative:1,rect:[17,1,1]}]})},MapPlatForm.Base.MapGeometryAnim.prototype._setDefaultCompType=function(){ht.Default.setCompType("bubble-shadow",function(t,e,a,i,r){if(null!=i.s("dia"+a.cid)){t.save(),t.beginPath(),t.globalAlpha=i.s("opacity"+a.cid);var o=e.x+e.width/2,s=e.y+e.height/2,n=i.s("dia"+a.cid),l=t.createRadialGradient(o,s,0,o,s,n);this._animPoint?(l.addColorStop(.1,i.s("startColor")),l.addColorStop(.8,i.s("endColor"))):(l.addColorStop(.1,i.s("startColor")),l.addColorStop(.8,i.s("startColor"))),t.fillStyle=l,t.arc(o,s,n/2,0,2*Math.PI),t.fill(),t.restore()}})},MapPlatForm.Base.MapGeometryAnim.prototype._begin=function(){var t=this;ht.Default.startAnim({duration:1e3,easing:ht.Default.getEasing("Linear"),action:function(e){t._animPoint||(e=1),t._dm.each(function(t){t.s("dia1",e*Math.min(t.getWidth(),t.getHeight()))})},finishFunc:function(){ht.Default.startAnim({duration:1e3,easing:ht.Default.getEasing("Linear"),action:function(e){t._animPoint||(e=0),t._dm.each(function(t){t.s("dia1",Math.min(t.getWidth(),t.getHeight())),t.s("opacity1",1-e)})},finishFunc:function(){t._dm.each(function(t){t.s("opacity1",1),t.s("dia1",0)}),t._begin()}}),ht.Default.startAnim({duration:1e3,easing:ht.Default.getEasing("Linear"),action:function(e){t._animPoint||(e=1),t._dm.each(function(t){t.s("dia2",e*Math.min(t.getWidth(),t.getHeight()))})},finishFunc:function(){ht.Default.startAnim({duration:1e3,easing:ht.Default.getEasing("Linear"),action:function(e){t._animPoint||(e=0),t._dm.each(function(t){t.s("dia2",Math.min(t.getWidth(),t.getHeight())),t.s("opacity2",1-e)})},finishFunc:function(){t._dm.each(function(t){t.s("opacity2",1),t.s("dia2",0)})}})}})}})},MapPlatForm.Base.MapGeometryAnim.prototype._objectExtend=function(t,e){t=t||{};for(var a in e)void 0===t[a]&&(t[a]=this._objectClone(e[a]));return t},MapPlatForm.Base.MapGeometryAnim.prototype._objectClone=function(t,e){if(null==t||"object"!=typeof t)return t;if(t.constructor!=Object&&t.constructor!=Array)return t;if(t.constructor==Date||t.constructor==RegExp||t.constructor==Function||t.constructor==String||t.constructor==Number||t.constructor==Boolean)return new t.constructor(t);e=e||new t.constructor;for(var a in t)e[a]="undefined"==typeof e[a]?this._objectClone(t[a],null):e[a];return e},MapPlatForm.Base.MapGeometryAnim.prototype._createShapePoints=function(t){var e=new ht.List;if(this._curve)e=this._createShapePointsForCurve(t);else{var a,i,r=0,o=t.length;for(r;r<o;r++)a=this._trafficUtil.wgs84ToMercator([t[r].lon,t[r].lat]),i=this._trafficUtil.mercatorToPixel([a.lon,a.lat],this._ctx),i.lonLat=a,e.add(i)}return e},MapPlatForm.Base.MapGeometryAnim.prototype._createShapePointsForCurve=function(t){var e=new ht.List,a=t.length,i=this._trafficUtil.wgs84ToMercator([t[0].lon,t[0].lat]),r=this._trafficUtil.wgs84ToMercator([t[a-1].lon,t[a-1].lat]),o=this._createControlPoint(i,r,this._degree),s=this._trafficUtil.mercatorToPixel([i.lon,i.lat],this._ctx),n=this._trafficUtil.mercatorToPixel([r.lon,r.lat],this._ctx),l=this._trafficUtil.mercatorToPixel([o.lon,o.lat],this._ctx);return s.lonLat=i,n.lonLat=r,l.lonLat=o,e.add(s),e.add(l),e.add(n),e},MapPlatForm.Base.MapGeometryAnim.prototype._createControlPoint=function(t,e,a){var i=t.lon,r=t.lat,o=e.lon,s=e.lat,n=(i+o)/2,l=(r+s)/2,h=(r-s)*a+n,p=(o-i)*a+l;return{lon:h,lat:p}},MAPPLATFORM_BASE_MAPGEOMETRYANIM_15=.1,MAPPLATFORM_BASE_MAPGEOMETRYANIM_30=.2,MAPPLATFORM_BASE_MAPGEOMETRYANIM_45=.3,MAPPLATFORM_BASE_MAPGEOMETRYANIM_60=.4,MAPPLATFORM_BASE_MAPGEOMETRYANIM_75=.5,MAPPLATFORM_BASE_MAPGEOMETRYANIM_NEGATIVE_15=-.1,MAPPLATFORM_BASE_MAPGEOMETRYANIM_NEGATIVE_30=-.2,MAPPLATFORM_BASE_MAPGEOMETRYANIM_NEGATIVE_45=-.3,MAPPLATFORM_BASE_MAPGEOMETRYANIM_NEGATIVE_60=-.4,MAPPLATFORM_BASE_MAPGEOMETRYANIM_NEGATIVE_75=-.5}(),function(){MapPlatForm.Base.MapLineAnim=function(t,e){this.CLASS_NAME="MapLineAnim",this._map=t,this._lines=[],this._newLine=[],this._circleSize=10,this._targetPoint,this._targetPixel,this._targetStyle,this._lineStyle,this.stop,this._xy=[],this._flowXy=[],this.step=1,this.k=0,this.speed=.05,this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.width=this._map._mapAdapter.map.viewPortDiv.offsetWidth,this.canvas.height=this._map._mapAdapter.map.viewPortDiv.offsetHeight,this.canvas.style.pointerEvents="none",this.canvas.style.zIndex=999,this._map._mapAdapter.map.viewPortDiv.appendChild(this.canvas),this.context=this.canvas.getContext("2d"),window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.requestAnimationFrame=window.requestAnimationFrame?window.requestAnimationFrame:function(t){window.setTimeout(t,300)},window.cancelAnimationFrame=window.cancelAnimationFrame?window.cancelAnimationFrame:function(t){window.clearTimeout(t)}},MapPlatForm.Base.MapLineAnim.prototype._drawAnimateMarker=function(){if(this._targetPixel){var t=this.context;t.beginPath(),this._circleSize+=1;var e=t.createRadialGradient(this._targetPixel.x,this._targetPixel.y,0,this._targetPixel.x,this._targetPixel.y,this._circleSize);e.addColorStop(0,this._targetStyle.color2),e.addColorStop(1,this._targetStyle.color),t.arc(this._targetPixel.x,this._targetPixel.y,this._circleSize,0,2*Math.PI),t.fillStyle=e,t.fill(),this._circleSize>35&&(this._circleSize=0)}},MapPlatForm.Base.MapLineAnim.prototype._drawFlowLine=function(){for(var t=this._flowXy.length-1;t>=0;t--)if(this._xy[this._flowXy[t]].obj[2]>.6){var e=Math.floor(this._xy[this._flowXy[t]].obj[2]*this._xy[this._flowXy[t]].points.length);e>this._xy[this._flowXy[t]].points.length-1&&(e=this._xy[this._flowXy[t]].points.length-1);for(var a=e;a<this._xy[this._flowXy[t]].points.length;a++){this.context.beginPath(),this.context.fillStyle="rgba(255, 255, 255,0.9)";var i=this._xy[this._flowXy[t]].points[a];this.context.arc(i.x,i.y,4,0,2*Math.PI,!0),this.context.fill()}}},MapPlatForm.Base.MapLineAnim.prototype._initInteractive=function(){this._map._mapAdapter.map.events.fallThrough=!0,this._map._mapAdapter.map.events.register("movestart",this,function(){this.canvas.style.display="none",window.cancelAnimationFrame(this.stop)}),this._map._mapAdapter.map.events.register("moveend",this,function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.style.display="block",this._resetLines(),this._drawLines()}),this._map._mapAdapter.map.events.register("zoomstart",this,function(){this.canvas.style.display="none",window.cancelAnimationFrame(this.stop)})},MapPlatForm.Base.MapLineAnim.prototype._drawLines=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this._drawFlowLine();for(var t=0;t<this._xy.length*this.step;t++){var e=this._xy[t].obj[0]+.5*(this._xy[t].obj[3]-this._xy[t].obj[0]),a=this._xy[t].obj[1]+.5*(this._xy[t].obj[4]-this._xy[t].obj[1]),i=(1-this._xy[t].obj[2])*(1-this._xy[t].obj[2])*this._xy[t].obj[0]+2*this._xy[t].obj[2]*(1-this._xy[t].obj[2])*e+this._xy[t].obj[2]*this._xy[t].obj[2]*this._xy[t].obj[3],r=(1-this._xy[t].obj[2])*(1-this._xy[t].obj[2])*this._xy[t].obj[1]+2*this._xy[t].obj[2]*(1-this._xy[t].obj[2])*a+this._xy[t].obj[2]*this._xy[t].obj[2]*this._xy[t].obj[4],o=(1-this._xy[t].obj[2])*(1-this._xy[t].obj[2])*i+2*this._xy[t].obj[2]*(1-this._xy[t].obj[2])*e+this._xy[t].obj[2]*this._xy[t].obj[2]*this._xy[t].obj[3],s=(1-this._xy[t].obj[2])*(1-this._xy[t].obj[2])*r+2*this._xy[t].obj[2]*(1-this._xy[t].obj[2])*a+this._xy[t].obj[2]*this._xy[t].obj[2]*this._xy[t].obj[4];this.context.beginPath();var n=this.context.createLinearGradient(this._xy[t].obj[0],this._xy[t].obj[1],o,s);n.addColorStop(0,this._lineStyle.color2),n.addColorStop(this._xy[t].obj[2],this._lineStyle.color),n.addColorStop(1,this._lineStyle.color2),this.context.strokeStyle=n,this.context.moveTo(this._xy[t].obj[0],this._xy[t].obj[1]);for(var l=this._getPointInBizer(this._xy[t].points,this._xy[t].obj[2]),h=1;h<this._xy[t].points.length;h++)this.context.lineTo(this._xy[t].points[h].x,this._xy[t].points[h].y);
this.context.globalAlpha=this._xy[t].obj[2],this.context.stroke(),this.context.beginPath(),this.context.font="14px 宋体",this.context.fillStyle="rgba(255, 255, 255,"+this._xy[t].obj[2]+")",this.context.fillText(".",l.x,l.y),this._xy[t].obj[2]+=this.speed,this._xy[t].obj[2]>=1&&(this.k++,this._xy[t].obj[2]=1),this._xy[t].obj[2]<0&&(this.k++,this._xy[t].obj[2]=0)}this.k>this._lines.length*this.step&&(this.k=0,this.speed>0?this.step++:this.step--,(this.step>1||this.step<1)&&(this.step=(this.step>1,1),this.speed=0-this.speed)),this._drawAnimateMarker();var p=this;this.stop=window.requestAnimationFrame(function(){p._drawLines()})},MapPlatForm.Base.MapLineAnim.prototype._getPointInBizer=function(t,e){var a=Math.floor(e*t.length)-1;return a=a<0?0:a,a=a>t.length-1?t.length:a,t[a]},MapPlatForm.Base.MapLineAnim.prototype._resetLines=function(t){this.k=0,this.step=1,this.speed=.05,this._xy=[],this._flowXy=[];for(var e=this._map._mapAdapter.map.getCenter(),a=this._map._mapAdapter.map.resolution,i=this._map._mapAdapter.map.getPixelFromLonLat(e),r=0;r<this._lines.length;r++){for(var o=this._lines[r].getPath(),s=[],n=t?[]:this._newLine[r],l=0;l<o.length;l++){if(t){var h=NPMapLib.T.setPoint(this._map,o[l]);n.push(h)}var p={x:i.x+(n[l].lon-e.lon)/a,y:i.y-(n[l].lat-e.lat)/a};s.push(p)}t&&this._newLine.push(n);var c=s[0],u=s[s.length-1],m={obj:[c.x,c.y,0,u.x,u.y],points:s};this._xy.push(m)}for(var r=30;r>=0;r--){var d=Math.floor(Math.random()*this._xy.length);this._flowXy.push(d)}this._targetPoint&&(this._targetPixel={x:i.x+(this._targetPoint.lon-e.lon)/a,y:i.y-(this._targetPoint.lat-e.lat)/a})},MapPlatForm.Base.MapLineAnim.prototype.addTargetPoint=function(t,e){if(t&&(this._targetPoint=NPMapLib.T.setPoint(this._map,t)),this._targetStyle=e,this._targetStyle?this._targetStyle.color=this._targetStyle.color?this._targetStyle.color:"rgba(255, 255, 255,0.9)":this._targetStyle={color:"rgba(255, 255, 255,0.9)"},this._targetStyle.color.indexOf(",")>-1)if(4===this._targetStyle.color.split(",").length){var a=this._targetStyle.color.lastIndexOf(","),i=this._targetStyle.color.lastIndexOf(")"),r=this._targetStyle.color.substring(a+1,i);this._targetStyle.color2=this._targetStyle.color.replace(r," 0")}else 3===this._targetStyle.color.split(",").length&&(this._targetStyle.color2=this._targetStyle.color.replace("rgb","rgba"),this._targetStyle.color2=this._targetStyle.color2.replace(")",", 0)"));else this._targetStyle.color2="rgba(255, 255, 255, 0)"},MapPlatForm.Base.MapLineAnim.prototype.addLines=function(t,e){if(this._lines=t,this._lineStyle=e,this._lineStyle?this._lineStyle.color=this._lineStyle.color?this._lineStyle.color:"rgba(255, 0, 0,0.3)":this._lineStyle={color:"rgba(255, 0, 0, 0.3)"},this._lineStyle.color.indexOf(",")>-1)if(4===this._lineStyle.color.split(",").length){var a=this._lineStyle.color.lastIndexOf(","),i=this._lineStyle.color.lastIndexOf(")"),r=this._lineStyle.color.substring(a+1,i);this._lineStyle.color2=this._lineStyle.color.replace(r," 0")}else 3===this._lineStyle.color.split(",").length&&(this._lineStyle.color2=this._lineStyle.color.replace("rgb","rgba"),this._lineStyle.color2=this._lineStyle.color2.replace(")",", 0)"));else this._lineStyle.color2="rgba(255, 255, 255, 0)";this._resetLines(!0),this._drawLines(),this._initInteractive()}}(),function(){var t=function(t,e,a,i){var r=NPMapLib.T.setPoint(e,t);this.map=e,this.opts=i,this.point=t,this.lonLat=r,this.visibile=!0,this.reset=function(t,e,a){this.x=e.x+(this.lonLat.lon-t.lon)/a-this.opts.width/2,this.y=e.y-(this.lonLat.lat-t.lat)/a-this.opts.height/2},this.draw=function(t){t&&(delete this.img,this.img=null,this.img=t),this.visibile&&a.drawImage(this.img,this.x,this.y,this.opts.width,this.opts.height)},this.hide=function(){this.visibile=!1},this.show=function(){this.visibile=!0},this.setStyle=function(t){if(t)if(t.width&&(this.opts.width=t.width),t.height&&(this.opts.height=t.height),t.url){var e=new Image;e.src=t.url;var a=this;e.onload=function(){a.draw(e)}}else this.draw()}};MapPlatForm.Base.MapMultiMarkers=function(t,e){this.CLASS_NAME="MapMultiMarkers",this._map=t,this._markers=[],this._showMarkers=[],this._imgMarkers={},this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.width=this._map._mapAdapter.map.viewPortDiv.offsetWidth,this.canvas.height=this._map._mapAdapter.map.viewPortDiv.offsetHeight,this.canvas.style.pointerEvents="none",this.canvas.style.zIndex=999,this._map._mapAdapter.map.viewPortDiv.appendChild(this.canvas),this.context=this.canvas.getContext("2d"),this.acvtiveMarker=null,this.mouseOver=e?e.mouseOver:null,this.mouseOut=e?e.mouseOut:null,this.click=e?e.click:null},MapPlatForm.Base.MapMultiMarkers.prototype._initInteractive=function(){this._map._mapAdapter.map.events.fallThrough=!0,this._map._mapAdapter.map.events.register("dragstart",this,function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.visibile=!1}),this._map._mapAdapter.map.events.register("movestart",this,function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.visibile=!1}),this._map._mapAdapter.map.events.register("moveend",this,function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);var t=this._map.getExtent(),e=this._map._mapAdapter.map.getCenter(),a=this._map._mapAdapter.map.resolution,i=this._map._mapAdapter.map.getPixelFromLonLat(e);this._showMarkers=[];for(var r=0;r<this._markers.length;r++)t.containsPoint(this._markers[r].point)&&(this._markers[r].reset(e,i,a),this._markers[r].draw(this._imgMarkers[this._markers[r].opts.url].img),this._markers[r].visibile&&this._showMarkers.push(this._markers[r]));this.canvas.style.display="block",this.visibile=!0}),this._map._mapAdapter.map.events.register("zoomstart",this,function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.visibile=!1});var t=this;this._map.getContainer().onmousemove=function(e){if(t.visibile){for(var a=t._showMarkers.length-1;a>=0;a--){var i=e.xy;if(i.x>=t._showMarkers[a].x&&i.x<=t._showMarkers[a].x+t._showMarkers[a].opts.width&&i.y>=t._showMarkers[a].y&&i.y<=t._showMarkers[a].y+t._showMarkers[a].opts.height)return void(t.acvtiveMarker!=t._showMarkers[a]&&(t.acvtiveMarker&&t.mouseOut&&t.mouseOut(t.acvtiveMarker),t._map.setCursor("pointer"),t.mouseOver&&(t.mouseOver(t._showMarkers[a]),t.acvtiveMarker=t._showMarkers[a])))}t._map.setCursor("default"),t.acvtiveMarker&&t.mouseOut&&t.mouseOut(t.acvtiveMarker),t.acvtiveMarker=null}},this._map.getContainer().onclick=function(e){if(t.visibile)for(var a=t._showMarkers.length-1;a>=0;a--){var i=e.xy;if(i.x>=t._showMarkers[a].x&&i.x<=t._showMarkers[a].x+t._showMarkers[a].opts.width&&i.y>=t._showMarkers[a].y&&i.y<=t._showMarkers[a].y+t._showMarkers[a].opts.height)return void(t.click&&t.click(t._showMarkers[a]))}}},MapPlatForm.Base.MapMultiMarkers.prototype.preventFlash=function(){this._map._mapAdapter.map.useMultiMarkers=!0},MapPlatForm.Base.MapMultiMarkers.prototype.addMarkers=function(e){for(var a=(this._map.getExtent(),this._map._mapAdapter.map.getCenter()),i=this._map._mapAdapter.map.resolution,r=this._map._mapAdapter.map.getPixelFromLonLat(a),o=this,s=0;s<e.length;s++){var n=new t(e[s],this._map,this.context,e[s].opts);n.data=e[s].data,this._imgMarkers[e[s].opts.url]?this._imgMarkers[e[s].opts.url].points.push(n):(this._imgMarkers[e[s].opts.url]={},this._imgMarkers[e[s].opts.url].points=[n],this._imgMarkers[e[s].opts.url].img=new Image),this._markers.push(n)}this._showMarkers=[];for(var l in this._imgMarkers)this._imgMarkers.hasOwnProperty(l)&&(this._imgMarkers[l].img.src=l,this._imgMarkers[l].img.k=l,this._imgMarkers[l].img.onload=function(){for(var t=0;t<o._imgMarkers[this.k].points.length;t++)o._imgMarkers[this.k].points[t].reset(a,r,i),o._imgMarkers[this.k].points[t].draw(o._imgMarkers[this.k].img),o._imgMarkers[this.k].points[t].visibile&&o._showMarkers.push(o._imgMarkers[this.k].points[t])});this.visibile=!0,this._initInteractive()},MapPlatForm.Base.MapMultiMarkers.prototype.getMarkers=function(){return this._markers},MapPlatForm.Base.MapMultiMarkers.prototype.refresh=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);var t=this._map.getExtent(),e=this._map._mapAdapter.map.getCenter(),a=this._map._mapAdapter.map.resolution,i=this._map._mapAdapter.map.getPixelFromLonLat(e);this._showMarkers=[];for(var r=0;r<this._markers.length;r++)t.containsPoint(this._markers[r].point)&&(this._markers[r].reset(e,i,a),this._markers[r].draw(this._imgMarkers[this._markers[r].opts.url].img),this._markers[r].visibile&&this._showMarkers.push(this._markers[r]));this.visibile=!0}}(),function(){MapPlatForm.Base.MapRoutePlan=function(t,e){this.CLASS_NAME="MapRoutePlan",this.map=t,this.layer=e?e:this.map.getDefaultLayer(),this.startMarker=null,this._planRoadType=1,this._currentPolyline=null,this.endMarker=null,this.editMarker=null,this._throughMarkerInfo={},this._routes=[],this._throughMarkerNum=0,this._routeIndex=0,this._mapService=new MapPlatForm.Base.MapService(t),this._mapGeometry=new MapPlatForm.Base.MapGeometry(t),this.result1=null,this.result2=null,this._researchCallback=function(){},this.routeGroup=this.layer.addGroup("route"),this.editGroup=this.layer.addGroup("route_edit"),this.defaultName="未知地址","EN"===NPMapLib.CULTURE&&(this.defaultName="Unknown Position"),window.getElementsByClassName=function(t){for(var e=[],a=document.getElementsByTagName("*"),i=0;i<a.length;i++)a[i].className===t&&(e[e.length]=a[i]);return e}},MapPlatForm.Base.MapRoutePlan.prototype._addPath=function(t){if(t.features.length<1||t.features.length<1)return void(this._errorCallBack&&this._errorCallBack instanceof Function&&("EN"===NPMapLib.CULTURE?this._errorCallBack("There is no suitable route, please re-drag！"):this._errorCallBack("没有合适的路线，请重新拖动！")));var e=t.features[0];e.setStyle({color:"red",weight:5}),this.routeGroup.addOverlay(e),e.setZIndex(0);var a=this;e.addEventListener("featuremoving",function(t,e){var i=new MapPlatForm.Base.MapGeometry(map);a.editMarker?(a.editMarker.setPosition(e),a.editMarker.show()):(a.editMarker=i.createMarker(e,{url:a._crossMarkerStyle.editImageUrl,size:{width:a._crossMarkerStyle.width,height:a._crossMarkerStyle.height},markerType:0}),a.editGroup.addOverlay(a.editMarker),a.editMarker.setZIndex(100),a.editMarker.isEnableEdit=!0,a.editMarker.enableEditing())})},MapPlatForm.Base.MapRoutePlan.prototype.addEidtMarkerEvent=function(){this.editMarker&&this.editMarker.addEventListener(NPMapLib.MARKER_EVENT_DRAG_END,function(t){_afterDrag(t)})},MapPlatForm.Base.MapRoutePlan.prototype._afterDrag=function(t,e,a){var i=null,r=null,o=null;e?(r=e.startPosition,o=e.stopPosition):(i=_currentPolyline.getPath(),r=i[0],o=i[i.length-1]);var s={startStop:r,endStop:t,trafficModel:"car",planRoadType:this._planRoadType},n=this;_mapService.searchRouteByCoor(s,function(i){s={startStop:t,endStop:o,trafficModel:"car",planRoadType:_planRoadType},_mapService.searchRouteByCoor(s,function(s){return i.features.length<1||s.features.length<1?void(n._errorCallBack&&n._errorCallBack instanceof Function&&("EN"==NPMapLib.CULTURE?n._errorCallBack("There is no suitable route, please re-drag！"):n._errorCallBack("没有合适的路线，请重新拖动！"))):void _addRoutes(t,{result1:i,result2:s,startPosition:r,stopPosition:o,throughMarkerRelativeInfo:e,key:a})})})},MapPlatForm.Base.MapRoutePlan.prototype._addRoutes=function(t){this.routeGroup.addOverlay(t.features[0])},MapPlatForm.Base.MapRoutePlan.prototype._clearEditInfoOnMap=function(){this.editGroup&&(this.editGroup.removeAllOverlays(),this.editMarker=null),this.routeGroup&&(this.routeGroup.removeAllOverlays(),this.editMarker=null),this.map.closeAllInfoWindows()},MapPlatForm.Base.MapRoutePlan.prototype._queryRoute=function(){var t={startStop:this._startMarker.getPosition(),endStop:this._endMarker.getPosition(),trafficModel:"car",planRoadType:this._planRoadType},e=this;this._mapService.searchRouteByCoor(t,function(t){if(t.features.length<1)return void(e._errorCallBack&&e._errorCallBack instanceof Function&&("EN"===NPMapLib.CULTURE?e._errorCallBack("There is no suitable route, please re-drag！"):e._errorCallBack("没有合适的路线，请重新拖动！")));var a=t.features[0];e._setPolylineStyle([a]),e.routeGroup.addOverlay(a),a.setData({index:e._routeIndex}),a.setZIndex(0),e._routeArray=[a],e._addEventToLines([a]),e._routes=[{index:e._routeIndex,dragIconIndex:{icon1:0,icon2:0},route:a,routeInfo:t.messages}];var i={routes:e._routes,polyline:a};e._researchCallback(i)})},MapPlatForm.Base.MapRoutePlan.prototype._addEventToLines=function(t){var e=this;if(t&&t instanceof Array)for(var a=t.length,i=0;i<a;i++)t[i].addEventListener("featuremoving",function(t,a){e.editMarker?(e.editMarker.setPosition(a),e.editMarker.show()):(e.editMarker=e._mapGeometry.createMarker(a,{url:e._crossMarkerStyle.editImageUrl,size:{width:e._crossMarkerStyle.width,height:e._crossMarkerStyle.height},markerType:0}),e.editGroup.addOverlay(e.editMarker),e.editMarker.enableEditing(),e.editMarker.setZIndex(100),e._dragEdit()),e.editMarker.setData({line:t})})},MapPlatForm.Base.MapRoutePlan.prototype._removeEventToLines=function(t){if(t&&t instanceof Array)for(var e=t.length,a=0;a<e;a++)t[a].removeEventListener("featuremoving")},MapPlatForm.Base.MapRoutePlan.prototype._dragEdit=function(){if(this.editMarker){this.editMarker.isEnableEdit=!0,this.editMarker.addEventListener("featuremousedown",function(t){t.removeEventListener("mouseout")});var t=this;this.editMarker.addEventListener("dragend",function(e){e.hide(),e.addEventListener("mouseout",function(t){t.hide()}),t._currentPolyline=e.getData().line,t._afterDrag(e.getPosition())}),this.editMarker.addEventListener(NPMapLib.MARKER_EVENT_DRAG_START,function(){for(var e=t.routeGroup.getAllOverlayers(),a=[],i=0;i<e.length;i++)"NPMapLib.Geometry.Polyline"===e[i].CLASS_NAME&&a.push(e[i]);t._removeEventToLines(a)}),this.editMarker.addEventListener("mouseout",function(t){t.hide()})}},MapPlatForm.Base.MapRoutePlan.prototype._getRelativeRoute=function(t){for(var e=null,a=null,i=0,r=this._routes.length;i<r;i++)if(this._routes[i].dragIconIndex.icon1===parseInt(t,10)||this._routes[i].dragIconIndex.icon2===parseInt(t,10))if(e){if(!a){a=this._routes[i];break}}else e=this._routes[i];return{route1:e,route2:a}},MapPlatForm.Base.MapRoutePlan.prototype._afterDrag=function(t,e){var a=null,i=null,r=null,o="add";if(e){var s=this._getRelativeRoute(e),n=s.route1.route.getPath(),l=s.route2.route.getPath();i=n[0],r=l[l.length-1],o="edit"}else a=this._currentPolyline.getPath(),i=a[0],r=a[a.length-1],o="add";var h,p,c,u={startStop:i,endStop:t,trafficModel:"car",planRoadType:this._planRoadType},m=this;this._mapService.searchRouteByCoor(u,function(a){h=a,m._searchRouteByDrag(t,o,s,e,h,p,c)});var d={startStop:t,endStop:r,trafficModel:"car",planRoadType:this._planRoadType},_=new MapPlatForm.Base.MapService(this.map);_.searchRouteByCoor(d,function(a){p=a,m._searchRouteByDrag(t,o,s,e,h,p,c)});var y=new MapPlatForm.Base.MapService(this.map);y.queryPOIByCoord(t,function(a){c=a,m._searchRouteByDrag(t,o,s,e,h,p,c)})},MapPlatForm.Base.MapRoutePlan.prototype._searchRouteByDrag=function(t,e,a,i,r,o,s){if(r&&o&&s){for(var n=this.routeGroup.getAllOverlayers(),l=[],h=0;h<n.length;h++)"NPMapLib.Geometry.Polyline"===n[h].CLASS_NAME&&l.push(n[h]);return this._addEventToLines(l),r.features.length<1||o.features.length<1?void(this._errorCallBack&&this._errorCallBack instanceof Function&&("EN"===NPMapLib.CULTURE?this._errorCallBack("There is no suitable route, please re-drag！"):this._errorCallBack("没有合适的路线，请重新拖动！"))):void this._getAddressByCoor(t,{result1:r,result2:o,type:e,relativeRoutes:a,key:i},s)}},MapPlatForm.Base.MapRoutePlan.prototype._getAddressByCoor=function(t,e,a){"add"===e.type?this._afteDragAdd(t,e,a):this._afterDragEdit(t,e,a)},MapPlatForm.Base.MapRoutePlan.prototype._afteDragAdd=function(t,e,a){var i=e.result1.features[0],r=e.result2.features[0];this._setPolylineStyle([i,r]),i.setData({index:++this._routeIndex}),r.setData({index:++this._routeIndex}),this.routeGroup.addOverlay(i),this.routeGroup.addOverlay(r),i.setZIndex(1),r.setZIndex(1),this._addEventToLines([i,r]);var o=this._crossMarkerStyle.crossImageUrl,s=this._mapGeometry.createMarker(t,{url:o,size:{width:this._crossMarkerStyle.width,height:this._crossMarkerStyle.height},markerType:0});this.editGroup.addOverlay(s),s.setZIndex(100);var n=a.data.name,l=n?n:this.defaultName;this._throughMarkerNum++,s.setData({key:this._throughMarkerNum,name:l});var h=this._getRouteByIndex(this._currentPolyline.getData().index),p=this._addInfowin(l,this._throughMarkerNum,t);this._throughMarkerInfo[this._throughMarkerNum]={infoWindow:p,marker:s},s.isEnableEdit=!0;var c=this;s.addEventListener("dragend",function(t){var e=parseInt(t.getData().key,10),a=c._throughMarkerInfo[e];a.infoWindow.close(),c._afterDrag(t.getPosition(),e)}),e.result1.messages.startPointName=h.routeInfo.startPointName,e.result2.messages.startPointName=l,this._refreshRouteArray({route1:{index:i.getData().index,dragIconIndex:{icon1:h.dragIconIndex.icon1,icon2:this._throughMarkerNum},route:i,routeInfo:e.result1.messages},route2:{index:r.getData().index,dragIconIndex:{icon1:this._throughMarkerNum,icon2:h.dragIconIndex.icon2},route:r,routeInfo:e.result2.messages},key:e.key},e.type),this.routeGroup.removeOverlay(this._currentPolyline)},MapPlatForm.Base.MapRoutePlan.prototype._afterDragEdit=function(t,e,a){var i=e.relativeRoutes;this.routeGroup.removeOverlay(i.route1.route),this.routeGroup.removeOverlay(i.route2.route);var r=e.result1.features[0],o=e.result2.features[0];this._setPolylineStyle([r,o]),r.setData({index:i.route1.route.getData().index}),o.setData({index:i.route2.route.getData().index}),this.routeGroup.addOverlay(r),this.routeGroup.addOverlay(o),r.setZIndex(1),o.setZIndex(1),this._addEventToLines([r,o]);var s=a.data.name,n=s?s:this.defaultName;this._throughMarkerInfo[e.key].marker.setData({key:e.key,name:n}),i.route1.route=r,i.route1.routeInfo=e.result1.messages,i.route2.route=o,i.route2.routeInfo=e.result2.messages,i.route2.routeInfo.startPointName=n;var l=this._addInfowin(n,e.key,t);this._throughMarkerInfo[e.key].infoWindow=l,this._refreshRouteArray({route1:i.route1,route2:i.route2,key:e.key},e.type)},MapPlatForm.Base.MapRoutePlan.prototype._getThroughInfo=function(t,e){var a=document.createElement("div");a.style.fontSize="13px",a.style.border="1px solid #dfdfdf",a.style.borderRadius="5px",a.style.webkitBorderRadius="5px",a.style.height="21px",a.style.backgroundColor="#fff";var i=document.createElement("span");i.style.maxWidth="100px",i.style.overflow="hidden",i.style.whiteSpace="nowrap",i.style.textOverflow="ellipsis",i.style["float"]="left",i.style.marginLeft="2px",i.style.display="inline-block",i.style.lineHeight="21px",i.innerText=t;var r=document.createElement("i");return r.style.width="14px",r.style.height="14px",r.style["float"]="left",r.style.display="inline-block",r.style.marginLeft="5px",r.style.marginTop="3px",r.style.cursor="pointer",r.style.background="url('"+OpenLayers.Util.getImageLocation("close.png")+"') no-repeat",r.className="infowindow-close",r.setAttribute("key",e),a.appendChild(i),a.appendChild(r),a},MapPlatForm.Base.MapRoutePlan.prototype._addInfowin=function(t,e,a){var i=this._getThroughInfo(t,e),r=new NPMapLib.Symbols.InfoWindow(a,"",i,{iscommon:!0,isAdaptation:!1,offset:new NPMapLib.Geometry.Size(7,(-9))});this.map.addOverlay(r),r.open();for(var o=document.getElementsByClassName("infowindow-close"),s=this,n=o.length-1;n>=0;n--)o[n].onclick=function(){key=this.getAttribute("key");var t=s._getRelativeRoute(key),e=t.route1.route.getPath(),a=t.route2.route.getPath(),i={startStop:e[0],endStop:a[a.length-1],trafficModel:"car",planRoadType:s._planRoadType};s._mapService.searchRouteByCoor(i,function(e){if(e.features[0]){var a=s._throughMarkerInfo[key];a.infoWindow.close(),s.editGroup.removeOverlay(a.marker),s.routeGroup.removeOverlay(t.route1.route),s.routeGroup.removeOverlay(t.route2.route);var i=e.features[0],r=++s._routeIndex;i.setData({index:r}),s._setPolylineStyle([i]),s.routeGroup.addOverlay(i),i.setZIndex(0),e.messages.startPointName=t.route1.routeInfo.startPointName,s._refreshRouteArray({route:{index:r,dragIconIndex:{icon1:t.route1.dragIconIndex.icon1,icon2:t.route2.dragIconIndex.icon2},route:e.features[0],routeInfo:e.messages},key:key},"delete"),s._addEventToLines([e.features[0]])}else s._errorCallBack()})};return r},MapPlatForm.Base.MapRoutePlan.prototype._refreshRouteArray=function(t,e){var a,i=null,r=null;if("add"===e){for(var o=this._currentPolyline.getData().index,s=0,n=this._routes.length;s<n;s++)if(this._routes[s].index===parseInt(o,10)){a=s;break}this._routes.splice(a,1,t.route1),this._routes.splice(a+1,0,t.route2)}else if("edit"===e){for(var s=0,n=this._routes.length;s<n;s++)if(this._routes[s].dragIconIndex.icon1===parseInt(t.key,10)||this._routes[s].dragIconIndex.icon2===parseInt(t.key,10))if(i){if(!r){r=this._routes[s],this._routes.splice(s,1,t.route2);break}}else i=this._routes[s],this._routes.splice(s,1,t.route1)}else for(var s=0,n=this._routes.length;s<n;s++)if(this._routes[s].dragIconIndex.icon1===parseInt(t.key,10)||this._routes[s].dragIconIndex.icon2===parseInt(t.key,10))if(i){if(!r){r=this._routes[s],this._routes.splice(s,1);break}}else i=this._routes[s],this._routes.splice(s,1,t.route);var l,h=[];if(this._routes&&this._routes.length>0){for(var s=0,n=this._routes.length;s<n;s++)h=h.concat(this._routes[s].route.getPath());l=new NPMapLib.Geometry.Polyline(h)}var p={routes:this._routes,polyline:l};this._researchCallback(p)},MapPlatForm.Base.MapRoutePlan.prototype._setPolylineStyle=function(t){if(t&&t instanceof Array)for(var e=t.length,a=0;a<e;a++)t[a].setStyle(this._lineStyle),t[a].setZIndex(0)},MapPlatForm.Base.MapRoutePlan.prototype._getRouteByIndex=function(t){for(var e=null,a=0,i=this._routes.length;a<i;a++)if(this._routes[a].index===parseInt(t,10)){e=this._routes[a];break}return e},MapPlatForm.Base.MapRoutePlan.prototype._refreshRelativeThroughInfo=function(t,e){var a=e.startPosition,i=e.stopPosition;for(var r in this._throughMarkerInfo)if(t!==parseInt(r)){var o=this._throughMarkerInfo[r].startPosition,s=this._throughMarkerInfo[r].stopPosition,n=this._throughMarkerInfo[r].crossPoint;a.lat===o.lat&&a.lon===o.lon&&(this._throughMarkerInfo[r].startPosition=e.crossPoint,this._throughMarkerInfo[r].route1=e.route2),i.lat===s.lat&&i.lon===s.lon&&(this._throughMarkerInfo[r].stopPosition=e.crossPoint,this._throughMarkerInfo[r].route2=e.route1),a.lat===n.lat&&a.lon===n.lon&&(this._throughMarkerInfo[r].stopPosition=e.crossPoint,this._throughMarkerInfo[r].route2=e.route1),i.lat===n.lat&&i.lon===n.lon&&(this._throughMarkerInfo[r].startPosition=e.crossPoint,this._throughMarkerInfo[r].route1=e.route2)}},MapPlatForm.Base.MapRoutePlan.prototype._refreshRelativeThroughInfoDel=function(t,e,a){var i=e.crossPoint;for(var r in _throughMarkerInfo)if(t!==parseInt(r)){var o=this._throughMarkerInfo[r].startPosition,s=this._throughMarkerInfo[r].stopPosition;i.lat===o.lat&&i.lon===o.lon&&(this._throughMarkerInfo[r].startPosition=e.startPosition,this._throughMarkerInfo[r].route1=a),i.lat===s.lat&&i.lon===s.lon&&(this._throughMarkerInfo[r].stopPosition=e.stopPosition,this._throughMarkerInfo[r].route2=a)}},MapPlatForm.Base.MapRoutePlan.prototype.addRoutePlanControl=function(t,e,a){if(this._planRoadType=t.planRoadType,this._startMarker=t.startMarker,this._endMarker=t.endMarker,this._lineStyle=t.lineStyle?t.lineStyle:{color:"#0080c0",weight:10,lineStyle:"1px solid #0080c0",opacity:.7},this._crossMarkerStyle=t.crossMarkerStyle?t.crossMarkerStyle:{crossImageUrl:OpenLayers.Util.getImageLocation("path-cross.png"),editImageUrl:OpenLayers.Util.getImageLocation("path-edit.png"),height:11,width:11},this._clearEditInfoOnMap(),this._researchCallback=e,this._errorCallBack=a,t.polyline){var i=t.polyline;this._setPolylineStyle([i]),this.routeGroup.addOverlay(i),i.setData({index:this._routeIndex}),this._routeArray=[i],this._addEventToLines([i]),this._routes=[{index:this._routeIndex,dragIconIndex:{icon1:0,icon2:0},route:i,routeInfo:""}]}else this._queryRoute()},MapPlatForm.Base.MapRoutePlan.prototype.stopEdit=function(){for(var t=this.routeGroup.getAllOverlayers(),e=[],a=0;a<t.length;a++)"NPMapLib.Geometry.Polyline"===t[a].CLASS_NAME&&e.push(t[a]);this._removeEventToLines(e),this.editGroup.removeOverlay(this.editMarker),this.editMarker=null;for(var i in this._throughMarkerInfo)this._throughMarkerInfo[i].marker&&this._throughMarkerInfo[i].marker.disableEditing();for(var r=document.getElementsByClassName("infowindow-close"),a=r.length-1;a>=0;a--)r[a].onclick=null},MapPlatForm.Base.MapRoutePlan.prototype.startEdit=function(){for(var t=this.routeGroup.getAllOverlayers(),e=[],a=0;a<t.length;a++)"NPMapLib.Geometry.Polyline"===t[a].CLASS_NAME&&e.push(t[a]);this._addEventToLines(e);for(var i in this._throughMarkerInfo)this._throughMarkerInfo[i].marker&&this._throughMarkerInfo[i].marker.enableEditing();for(var r=document.getElementsByClassName("infowindow-close"),o=this,a=r.length-1;a>=0;a--)r[a].onclick=function(){key=this.getAttribute("key");var t=o._getRelativeRoute(key),e=t.route1.route.getPath(),a=t.route2.route.getPath(),i={startStop:e[0],endStop:a[a.length-1],trafficModel:"car",planRoadType:o._planRoadType};o._mapService.searchRouteByCoor(i,function(e){if(e.features[0]){var a=o._throughMarkerInfo[key];a.infoWindow.close(),o.editGroup.removeOverlay(a.marker),o.routeGroup.removeOverlay(t.route1.route),o.routeGroup.removeOverlay(t.route2.route);var i=e.features[0],r=++o._routeIndex;i.setData({index:r}),o._setPolylineStyle([i]),o.routeGroup.addOverlay(i),i.setZIndex(0),e.messages.startPointName=t.route1.routeInfo.startPointName,o._refreshRouteArray({route:{index:r,dragIconIndex:{icon1:t.route1.dragIconIndex.icon1,icon2:t.route2.dragIconIndex.icon2},route:e.features[0],routeInfo:e.messages},key:key},"delete"),o._addEventToLines([e.features[0]])}else o._errorCallBack()})}}}(),function(){MapPlatForm.Base.MapService=function(t){this.CLASS_NAME="MapService",this._currentService=null,this.map=t,this.mapConfig=new MapPlatForm.Base.MapConfig,this.mapGeometry=new MapPlatForm.Base.MapGeometry(this.map),this.routeService=null},MapPlatForm.Base.MapService.prototype.queryRoadByName=function(roadName,callBack){var url=this.mapConfig.dataServiceURL+"query/getRoadsByName",service=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),params=new NPMapLib.Services.queryParams;params={roadName:roadName},this.queryRoadByNameService&&(this.queryRoadByNameService.abort(),this.queryRoadByNameService=null),this.queryRoadByNameService=service.query(url,params,function(result){for(var lines=[],i=result.length-1;i>=0;i--){var geometry=eval("("+result[i].feature+")"),obj={},line=GeoJSON.read(geometry);if(line instanceof Array)for(var j=line.length-1;j>=0;j--)line[j].data=result[i];else line.data=result[i];obj.name=result[i].name,obj.geometry=line,lines.push(obj)}callBack instanceof Function&&callBack(lines)})},MapPlatForm.Base.MapService.prototype.getGeometryBuffer=function(t,e,a){var i=this.mapConfig.dataServiceURL+"gis/buffer",r=new NPMapLib.Services.bufferParams;r.projection=this.map.getProjection(),r.distance=e,r.units="m",r.geometry=t;var o=new NPMapLib.Services.BufferService(this.map,NPMapLib.MAPTYPE_NPGIS);this.geometryBufferService&&(this.geometryBufferService.abort(),this.geometryBufferService=null),this.geometryBufferService=o.buffer(i,r,a)},MapPlatForm.Base.MapService.prototype.queryPOIByName=function(name,callBack,maxResult,rowIndex){var url=this.mapConfig.dataServiceURL+"query/poiname",service=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),params=new NPMapLib.Services.queryParams;params.keyWord=name,params.maxResult=maxResult,params.rowIndex=rowIndex,this.queryPOIByNameService&&(this.queryPOIByNameService.abort(),this.queryPOIByNameService=null),this.queryPOIByNameService=service.query(url,params,function(result){for(var points=[],i=0;i<result.features.length;i++){var geometry=eval("("+result.features[i].geometry+")");if("Point"===geometry.type||"point"===geometry.type){var point=new NPMapLib.Geometry.Point(geometry.coordinates[0],geometry.coordinates[1]);point.data=result.features[i],points.push(point)}}callBack instanceof Function&&callBack(points,result)})},MapPlatForm.Base.MapService.prototype.queryPOIByCoord=function(point,callBack){var url=this.mapConfig.dataServiceURL+"query/poicoord",service=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),params=new NPMapLib.Services.queryParams;params={coord:point.lon+","+point.lat},this.queryPOIByCoordService&&(this.queryPOIByCoordService.abort(),this.queryPOIByCoordService=null),this.queryPOIByCoordService=service.query(url,params,function(result){var point;if(result&&result.geometry){var geometry=eval("("+result.geometry+")");"Point"!==geometry.type&&"point"!==geometry.type||(point=new NPMapLib.Geometry.Point(geometry.coordinates[0],geometry.coordinates[1]),point.data=result)}callBack instanceof Function&&callBack(point)})},MapPlatForm.Base.MapService.prototype.addPOI=function(t,e){var a=this.mapConfig.dataServiceURL+"query/addPoi",i=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),r=new NPMapLib.Services.queryParams;r={name:t.data.name,poiType:t.data.type,address:t.data.address,x:t.lon,y:t.lat},this.addPOIService&&(this.addPOIService.abort(),this.addPOIService=null),this.addPOIService=i.updata(a,r,function(a){a?(t.data=a,e instanceof Function&&e(t)):e instanceof Function&&e(null)})},MapPlatForm.Base.MapService.prototype.updataPOI=function(t,e){var a=this.mapConfig.dataServiceURL+"query/updataPoi",i=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),r=new NPMapLib.Services.queryParams;r={gid:t.data.gid,name:t.data.name,poiType:t.data.type,address:t.data.address,x:t.lon,y:t.lat},this.updataPOIService&&(this.updataPOIService.abort(),this.updataPOIService=null),this.updataPOIService=i.updata(a,r,function(a){a?(t.data=a,e instanceof Function&&e(t)):e instanceof Function&&e(null)})},MapPlatForm.Base.MapService.prototype.queryPOIByGeometry=function(geometry,callBack,maxResult,rowIndex){var url=this.mapConfig.dataServiceURL+"query/searchInBounds",wktGeo=this.mapGeometry.getWKTByGeometry(geometry),service=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),params=new NPMapLib.Services.queryParams;params.wkt=wktGeo,params.maxResult=maxResult,params.rowIndex=rowIndex,this.queryPOIByGeometryService&&(this.queryPOIByGeometryService.abort(),this.queryPOIByGeometryService=null),this.queryPOIByGeometryService=service.query(url,params,function(result){for(var points=[],i=0;i<result.data.length;i++){var geometry=eval("("+result.data[i].geometry+")");if("Point"===geometry.type||"point"===geometry.type){var point=new NPMapLib.Geometry.Point(geometry.coordinates[0],geometry.coordinates[1]);point.data=result.data[i],points.push(point)}}callBack instanceof Function&&callBack(points,result.pageCount,result.totalCount)})},MapPlatForm.Base.MapService.prototype.queryPOIByFilter=function(filter,callBack,maxResult,rowIndex){var url=this.mapConfig.dataServiceURL+"query/poiname",service=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),params=new NPMapLib.Services.queryParams;params.maxResult=maxResult,params.rowIndex=rowIndex;var fs=filter.split("=");params.type=fs[0],params.keyWord=fs[1],this.queryPOIByFilterService&&(this.queryPOIByFilterService.abort(),this.queryPOIByFilterService=null),this.queryPOIByFilterService=service.query(url,params,function(result){for(var points=[],i=0;i<result.features.length;i++){var geometry=eval("("+result.features[i].geometry+")");if("Point"===geometry.type||"point"===geometry.type){var point=new NPMapLib.Geometry.Point(geometry.coordinates[0],geometry.coordinates[1]);point.data=result.features[i],points.push(point)}}callBack instanceof Function&&callBack(points,result.pageCount,result.totalCount)})},MapPlatForm.Base.MapService.prototype.queryPOIByGeometryAndFilter=function(geometry,filter,callBack,maxResult,rowIndex){var url=this.mapConfig.dataServiceURL+"query/searchInBounds",wktGeo=this.mapGeometry.getWKTByGeometry(geometry),service=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),params=new NPMapLib.Services.queryParams;
params.wkt=wktGeo,params.maxResult=maxResult,params.rowIndex=rowIndex;var fs=filter.split("=");params.type=fs[0],params.keyWord=fs[1],this.queryPOIByGeometryAndFilterService&&(this.queryPOIByGeometryAndFilterService.abort(),this.queryPOIByGeometryAndFilterService=null),this.queryPOIByGeometryAndFilterService=service.query(url,params,function(result){for(var points=[],i=0;i<result.data.length;i++){var geometry=eval("("+result.data[i].geometry+")");if("Point"===geometry.type||"point"===geometry.type){var point=new NPMapLib.Geometry.Point(geometry.coordinates[0],geometry.coordinates[1]);point.data=result.data[i],points.push(point)}}callBack instanceof Function&&callBack(points,result.pageCount,result.totalCount)})},MapPlatForm.Base.MapService.prototype.queryRoadCrossByName=function(t,e){var a=this.mapConfig.dataServiceURL+"query/getRoadCrossByName",i=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),r=new NPMapLib.Services.queryParams;r.roadName=t,this.queryRoadCrossByNameService&&(this.queryRoadCrossByNameService.abort(),this.queryRoadCrossByNameService=null),this.queryRoadCrossByNameService=i.query(a,r,function(t){for(var a=[],i=0;i<t.length;i++){var r=new NPMapLib.Geometry.Point(t[i].lon,t[i].lat);r.data=t[i],a.push(r)}e instanceof Function&&e(a)})},MapPlatForm.Base.MapService.prototype.queryRoadCrossByGeometry=function(t,e){var a=this.mapGeometry.getWKTByGeometry(t),i=this.mapConfig.dataServiceURL+"query/searchRoadCrossInBounds",r=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),o=new NPMapLib.Services.queryParams;o.wkt=a,this.queryRoadCrossByGeometryService&&(this.queryRoadCrossByGeometryService.abort(),this.queryRoadCrossByGeometryService=null),this.queryRoadCrossByGeometryService=r.query(i,o,function(t){for(var a=[],i=0;i<t.data.length;i++){var r=new NPMapLib.Geometry.Point(t.data[i].lon,t.data[i].lat);r.data=t.data,a.push(r)}e instanceof Function&&e(a)})},MapPlatForm.Base.MapService.prototype.queryAllFeaturesByName=function(t,e){var a=this.mapConfig.dataServiceURL+"query/getFOIByName",i=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),r=new NPMapLib.Services.queryParams;r.keyWordString=t,this.queryFeaturesByNameService&&(this.queryFeaturesByNameService.abort(),this.queryFeaturesByNameService=null),this.queryFeaturesByNameService=i.query(a,r,function(t){for(var a=new MapPlatForm.Base.MapGeometry(this.map),i=[],r=0;r<t.length;r++){var o=null,s={};"road"===t[r].type?(s.address=t[r].address,o=a.getGeometryByGeoJson(t[r].feature)):"poi"===t[r].type?(s.address=t[r].address,o=a.getGeometryByGeoJson(t[r].wkt)):o=a.getGeometryByGeoJson(t[r].wkt),s.name=t[r].name,s.type=t[r].type,s.geometry=o,i.push(s)}e instanceof Function&&e(i)})},MapPlatForm.Base.MapService.prototype.addRoadCross=function(t){var e=this.mapConfig.dataServiceURL+"query/addRoadCross",a=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),i=new NPMapLib.Services.queryParams;i={name:t.data.name,x:t.lon,y:t.lat},this.addRoadCrossService&&(this.addRoadCrossService.abort(),this.addRoadCrossService=null),this.addRoadCrossService=a.updata(e,i,function(t){var e;t?(e.data=t,callBack instanceof Function&&callBack(e)):callBack instanceof Function&&callBack(null)})},MapPlatForm.Base.MapService.prototype.updataRoadCross=function(t){var e=this.mapConfig.dataServiceURL+"query/updataRoadCross",a=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),i=new NPMapLib.Services.queryParams;i={gid:t.data.gid,name:t.data.name,x:t.lon,y:t.lat},this._updataRoadCrossService&&(this._updataRoadCrossService.abort(),this._updataRoadCrossService=null),this._updataRoadCrossService=a.updata(e,i,function(t){var e;t?(e.data=t,callBack instanceof Function&&callBack(e)):callBack instanceof Function&&callBack(null)})},MapPlatForm.Base.MapService.prototype.searchRouteByCoor=function(t,e){var a=new NPMapLib.Services.RouteService(this.map,7),i=new NPMapLib.Services.routeParams;i.service="na",i.request="getroute",i.networkName="shanghai_roadnet_supermap",i.startStop=t.startStop,i.endStop=t.endStop,i.trafficModel=t.trafficModel,i.planRoadType=t.planRoadType,i.geoBarriers=[],i.algorithm="Dijkstra",this.routeService&&(this.routeService.abort(),this.routeService=null),this.routeService=a.route(this.mapConfig.dataServiceURL+"/gis/na",i,e)},MapPlatForm.Base.MapService.prototype.searchRouteByMultiPoints=function(t,e,a){for(var i=new NPMapLib.Services.RouteService(this.map,7),r=new NPMapLib.Services.routeParams,o="",s=0;s<t.length;s++)o+=t[s].lon+","+t[s].lat+";";o=o.substr(0,o.length-1),r.stops=o,this.routeMultiService&&(this.routeMultiService.abort(),this.routeMultiService=null),this.routeMultiService=i.routeByMultPoints(this.mapConfig.dataServiceURL+"/gis/routing",r,function(t){var a=[];if(t&&t instanceof Array)for(var i=0;i<t.length;i++){for(var r=[],o=t[i].expend.split(";"),s=0;s<o.length;s++){var n=o[s].split(","),l=parseFloat(n[0]),h=parseFloat(n[1]);r.push(new NPMapLib.Geometry.Point(l,h))}var p=new NPMapLib.Geometry.Polyline(r);p.setData({length:t[i].length,start:new NPMapLib.Geometry.Point(parseFloat(t[i].start.split(",")[0]),parseFloat(t[i].start.split(",")[1])),end:new NPMapLib.Geometry.Point(parseFloat(t[i].end.split(",")[0]),parseFloat(t[i].end.split(",")[1]))}),a.push(p)}e(a)},a)},MapPlatForm.Base.MapService.prototype.searchDistrictsByID=function(t,e){var a=this.mapConfig.dataServiceURL+"query/getRegionalBound",i=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),r=new NPMapLib.Services.queryParams;r={addvcd:t},this._searchDistrictsService&&(this._searchDistrictsService.abort(),this._searchDistrictsService=null);var o=this;this._searchDistrictsService=i.query(a,r,function(t){if(t){if(t.geometry&&(t.geometry=o.mapGeometry.getGeometryByGeoJson(t.geometry)),t.districts)for(var a=0;a<t.districts.length;a++)t.districts[a].geometry&&(t.districts[a].geometry=o.mapGeometry.getGeometryByGeoJson(t.districts[a].geometry));e instanceof Function&&e(t)}else e instanceof Function&&e(null)})},MapPlatForm.Base.MapService.prototype.searchDistrictsByName=function(t,e){var a=this.mapConfig.dataServiceURL+"query/getRegionalBoundByName",i=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),r=new NPMapLib.Services.queryParams;r={name:t},this._searchDistrictsService&&(this._searchDistrictsService.abort(),this._searchDistrictsService=null);var o=this;this._searchDistrictsService=i.query(a,r,function(t){if(t){if(t.geometry&&(t.geometry=o.mapGeometry.getGeometryByGeoJson(t.geometry)),t.districts)for(var a=0;a<t.districts.length;a++)t.districts[a].geometry&&(t.districts[a].geometry=o.mapGeometry.getGeometryByGeoJson(t.districts[a].geometry));e instanceof Function&&e(t)}else e instanceof Function&&e(null)})},MapPlatForm.Base.MapService.prototype.searchPanoramaByPoint=function(t,e,a){var i=this.mapConfig.dataServiceURL+"panorama/getConfigsByPosition",r=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),o=new NPMapLib.Services.queryParams;o={position:this.mapGeometry.getWKTByGeometry(t),distance:e},this._searchPanoramaByPoint&&(this._searchPanoramaByPoint.abort(),this._searchPanoramaByPoint=null);this._searchPanoramaByPoint=r.query(i,o,function(t){t?a instanceof Function&&a(t):a instanceof Function&&a(null)})},MapPlatForm.Base.MapService.prototype.searchSNPanoramaPoints=function(t){var e=this.mapConfig.dataServiceURL+"panorama/getAllSnPoints",a=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),i=new NPMapLib.Services.queryParams;i={},this._searchSNPanoramaPoints&&(this._searchSNPanoramaPoints.abort(),this._searchSNPanoramaPoints=null);this._searchSNPanoramaPoints=a.query(e,i,function(e){e?t instanceof Function&&t(e):t instanceof Function&&t(null)})},MapPlatForm.Base.MapService.prototype.searchSNPanoramaByPointID=function(t,e){var a=this.mapConfig.dataServiceURL+"panorama/getSnConfigsByParentId",i=new NPMapLib.Services.QueryService(NPMapLib.MAPTYPE_NPGIS),r=new NPMapLib.Services.queryParams;r={parentid:t},this._searchSNPanoramaByPointID&&(this._searchSNPanoramaByPointID.abort(),this._searchSNPanoramaByPointID=null);this._searchSNPanoramaByPointID=i.query(a,r,function(t){t?e instanceof Function&&e(t):e instanceof Function&&e(null)})},MapPlatForm.Base.MapService.prototype.cancelService=function(){this.queryPOIByFilterService&&(this.queryPOIByFilterService.abort(),this.queryPOIByFilterService=null),this.addRoadCrossService&&(this.addRoadCrossService.abort(),this.addRoadCrossService=null),this.queryPOIByGeometryService&&(this.queryPOIByGeometryService.abort(),this.queryPOIByGeometryService=null),this.updataPOIService&&(this.updataPOIService.abort(),this.updataPOIService=null),this._updataRoadCrossService&&(this._updataRoadCrossService.abort(),this._updataRoadCrossService=null),this.addPOIService&&(this.addPOIService.abort(),this.addPOIService=null),this.queryRoadByNameService&&(this.queryRoadByNameService.abort(),this.queryRoadByNameService=null),this.queryRoadCrossByGeometryService&&(this.queryRoadCrossByGeometryService.abort(),this.queryRoadCrossByGeometryService=null),this.queryPOIByGeometryAndFilterService&&(this.queryPOIByGeometryAndFilterService.abort(),this.queryPOIByGeometryAndFilterService=null),this.queryRoadCrossByNameService&&(this.queryRoadCrossByNameService.abort(),this.queryRoadCrossByNameService=null),this.routeService&&(this.routeService.abort(),this.routeService=null)}}(),function(){var t=function(t,e,a,i){var r=NPMapLib.T.setPoint(e,t);this.map=e,this.opts=i,this.point=t,this.lonLat=r,this.text=".",this.color="white",this.getColor=function(){var t=Math.random();t<.5?this.color=this.opts.starColor?this.opts.starColor:"#303845":this.color=this.opts.endColor?this.opts.endColor:"white"},this.init=function(){this.getColor()},this.reset=function(t,e,a){this.x=e.x+(this.lonLat.lon-t.lon)/a,this.y=e.y-(this.lonLat.lat-t.lat)/a},this.draw=function(){a.font="14px 宋体",a.fillStyle=this.color,a.fillText(this.text,this.x,this.y)}};MapPlatForm.Base.MapStar=function(t,e){this.CLASS_NAME="MapStar",this._map=t,this._opts=e?e:{starColor:"#303845",endColor:"white",freshTime:500},this._stars=[],this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.width=this._map._mapAdapter.map.viewPortDiv.offsetWidth,this.canvas.height=this._map._mapAdapter.map.viewPortDiv.offsetHeight,this.canvas.style.pointerEvents="none",this.canvas.style.zIndex=999,this._map._mapAdapter.map.viewPortDiv.appendChild(this.canvas),this.context=this.canvas.getContext("2d")},MapPlatForm.Base.MapStar.prototype._playStars=function(){for(var t=0;t<this._stars.length;t++)this._stars[t].show&&(this._stars[t].getColor(),this._stars[t].draw());var e=this,a=this._opts.freshTime?this._opts.freshTime:500;this.timeID=setTimeout(function(){e._playStars()},a)},MapPlatForm.Base.MapStar.prototype._initInteractive=function(){this._map._mapAdapter.map.events.fallThrough=!0,this._map._mapAdapter.map.events.register("movestart",this,function(){window.clearTimeout(this.timeID),this.canvas.style.display="none"}),this._map._mapAdapter.map.events.register("moveend",this,function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.style.display="block";for(var t=this._map.getExtent(),e=this._map._mapAdapter.map.getCenter(),a=this._map._mapAdapter.map.resolution,i=this._map._mapAdapter.map.getPixelFromLonLat(e),r=0;r<this._stars.length;r++)t.containsPoint(this._stars[r].point)?(this._stars[r].reset(e,i,a),this._stars[r].draw(),this._stars[r].show=!0):this._stars[r].show=!1;this._playStars()}),this._map._mapAdapter.map.events.register("zoomstart",this,function(){this.canvas.style.display="none",window.clearTimeout(this.timeID)})},MapPlatForm.Base.MapStar.prototype.addStars=function(e){for(var a=this._map.getExtent(),i=this._map._mapAdapter.map.getCenter(),r=this._map._mapAdapter.map.resolution,o=this._map._mapAdapter.map.getPixelFromLonLat(i),s=0;s<e.length;s++){var n=new t(e[s],this._map,this.context,this._opts);a.containsPoint(n.point)&&(n.show=!0,n.init(),n.reset(i,o,r),n.draw()),this._stars.push(n)}}}(),function(){MapPlatForm.Base.MapTag=function(t,e){this.CLASS_NAME="MapTag",this.layer=e,this.map=t,this._activeMarker=null,this.callback=null,this._mapGeometry=new MapPlatForm.Base.MapGeometry(t),this.markerParam=null,this.layer||(this.layer=this.map.getDefaultLayer()),self=this,this.isclick=!1},MapPlatForm.Base.MapTag.prototype._clickCallBack=function(){if(self.isclick||!self._activeMarker)return void self.delAdrawMarker();self.isclick=!0;var t=self._mapGeometry.createMarker(self._activeMarker.getPosition(),self.markerParam);self.layer.addOverlay(t),self.delAdrawMarker(),self.callback&&self.callback instanceof Function&&self.callback(t)},MapPlatForm.Base.MapTag.prototype._moveCallBack=function(t){var e=t.object,a=e.getLonLatFromPixel(t.xy),i=new NPMapLib.Geometry.Point(a.lon,a.lat);i=NPMapLib.T.getPoint(self.map,i),self._activeMarker?self.isclick||self._activeMarker.setPosition(i):(self._activeMarker=self._mapGeometry.createMarker(i,self.markerParam),self.layer.addOverlay(self._activeMarker),self._activeMarker.addEventListener("click",self._clickCallBack),self._activeMarker.addEventListener("rightclick",function(){self._activeMarker&&(self.delAdrawMarker(),self.cancelCallback&&self.cancelCallback())}))},MapPlatForm.Base.MapTag.prototype._rigthClickCallBack=function(){self._activeMarker&&(self.delAdrawMarker(),self.cancelCallback&&self.cancelCallback())},MapPlatForm.Base.MapTag.prototype.adrawMarker=function(t,e,a,i,r){this.markerParam=t,this.isclick=!1,this.delAdrawMarker(),this.callback=e,this.cancelCallback=r,this.layer.removeOverlay(this._activeMarker),this._activeMarker=null,this._contextHeight="20px","EN"===NPMapLib.CULTURE?(this.map.activateMouseContext("Click on add annotations, right click to cancel"),this._contextHeight="34px"):this.map.activateMouseContext("点击添加标注,右键取消");var o=this.map.getMouseContextStyle();if(o.height=this._contextHeight,a&&this.map.activateMouseContext(a),i)for(var s in i)o[s]=i[s];self=this,this.map.addEventListener(NPMapLib.MAP_EVENT_MOUSE_MOVE,function(t){self._activeMarker?self._activeMarker.setPosition(t):(self._activeMarker=self._mapGeometry.createMarker(t,self.markerParam),self.layer.addOverlay(self._activeMarker),self._activeMarker.addEventListener("click",self._clickCallBack),self._activeMarker.addEventListener("rightclick",function(){self._activeMarker&&(self.delAdrawMarker(),this.cancelCallback&&this.cancelCallback())}))}),this.map.addEventListener(NPMapLib.MAP_EVENT_RIGHT_CLICK,function(){self._activeMarker&&(self.delAdrawMarker(),this.cancelCallback&&this.cancelCallback())}),this.map.addEventListener(NPMapLib.MAP_EVENT_CLICK,self._clickCallBack),this.map.getContainer().onmouseenter=function(){self._activeMarker&&self._activeMarker.show()},this.map.getContainer().onmouseleave=function(){self._activeMarker&&self._activeMarker.hide()}},MapPlatForm.Base.MapTag.prototype.delAdrawMarker=function(){this.map&&(this._activeMarker&&(this._activeMarker.removeEventListener("click"),this._activeMarker.removeEventListener("rightclick")),this.layer.removeOverlay(this._activeMarker),this.map.deactivateMouseContext(),this.map.removeEventListener(NPMapLib.MAP_EVENT_CLICK),this.map.removeEventListener(NPMapLib.MAP_EVENT_MOUSE_OVER),this.map.removeEventListener(NPMapLib.MAP_EVENT_MOUSE_OUT),this.map.removeEventListener(NPMapLib.MAP_EVENT_MOUSE_MOVE))}}(),function(){MapPlatForm.Base.MapTools=function(t,e){this.CLASS_NAME="MapTools",this.map=t,this.measureTool=null,this.drawTool=null,this.searchCircle=null,this.editMarker=null,this.layer=e},MapPlatForm.Base.MapTools.prototype._initMeasureTool=function(){this.measureTool=new NPMapLib.Tools.MeasureTool(this.map.id,{lengthUnit:NPMapLib.MAP_UNITS_METERS,areaUnit:NPMapLib.MAP_UNITS_SQUARE_KILOMETERS,mode:NPMapLib.MEASURE_MODE_DISTANCE})},MapPlatForm.Base.MapTools.prototype._getStyle=function(t){return t?t.cursor="crosshair":t={cursor:"crosshair"},t},MapPlatForm.Base.MapTools.prototype._initDrawTool=function(){this.drawTool=new NPMapLib.Tools.DrawingTool(this.map.id),this.map.MapTools=this},MapPlatForm.Base.MapTools.prototype.measureDistance=function(){this.measureTool||this._initMeasureTool(),this.cancelMeasure(),this.cancelDraw(),this.measureTool.startUp(),this.measureTool.setMode(NPMapLib.MEASURE_MODE_DISTANCE)},MapPlatForm.Base.MapTools.prototype.measureArea=function(){this.measureTool||this._initMeasureTool(),this.cancelMeasure(),this.cancelDraw(),this.measureTool.startUp(),this.measureTool.setMode(NPMapLib.MEASURE_MODE_AREA)},MapPlatForm.Base.MapTools.prototype.cancelMeasure=function(){if(this.measureTool)try{this.measureTool.stop()}catch(t){this.measureTool._stop()}},MapPlatForm.Base.MapTools.prototype.cancelDraw=function(){this.drawTool&&this.drawTool.cancel()},MapPlatForm.Base.MapTools.prototype.drawLine=function(t,e){this.drawTool||this._initDrawTool(),this.cancelMeasure(),this.cancelDraw(),this.drawTool.startUp(t),e=this._getStyle(e),this.drawTool.setMode(NPMapLib.DRAW_MODE_POLYLINE,t,e)},MapPlatForm.Base.MapTools.prototype.drawRectangle=function(t,e){this.drawTool||this._initDrawTool(),this.cancelMeasure(),this.cancelDraw(),this.drawTool.startUp(t),e=this._getStyle(e),this.drawTool.setMode(NPMapLib.DRAW_MODE_RECT,t,e)},MapPlatForm.Base.MapTools.prototype.drawCircle=function(t,e){this.drawTool||this._initDrawTool(),this.cancelMeasure(),this.cancelDraw(),this.drawTool.startUp(t),e=this._getStyle(e),this.drawTool.setMode(NPMapLib.DRAW_MODE_CIRCLE,t,e)},MapPlatForm.Base.MapTools.prototype.drawPolygon=function(t,e){this.drawTool||this._initDrawTool(),this.cancelMeasure(),this.cancelDraw(),this.drawTool.startUp(t),e=this._getStyle(e),this.drawTool.setMode(NPMapLib.DRAW_MODE_POLYLGON,t,e)},MapPlatForm.Base.MapTools.prototype.drawCircleByDiameter=function(t,e){this.drawTool||this._initDrawTool(),this.cancelMeasure(),this.cancelDraw(),this.drawTool.startUp(t),e=this._getStyle(e),this.drawTool.setMode(NPMapLib.DRAW_MODE_CIRCLE_DIAMETER,t,e)},MapPlatForm.Base.MapTools.prototype.drawFreehand=function(t,e){this.drawTool||this._initDrawTool,this.cancelMeasure,this.cancelDraw,this.drawTool.startUp(t),e=this._getStyle(e),this.drawTool.setMode(NPMapLib.DRAW_MODE_FREEHAND,t,e)},MapPlatForm.Base.MapTools.prototype.addCircleSearchControl=function(t,e,a,i,r){var o=this,s=1e3,n="米";"EN"===NPMapLib.CULTURE&&(n="M"),a?s=a:a=500,i||(i=5e3),r&&r>=a&&r<=i&&(s=r);var l=e;this.searchCircle=new NPMapLib.Geometry.Circle(t,s,{color:"#acb9d1",fillColor:"#6980bc",weight:2,opacity:1,fillOpacity:.2});var h=this.map.getDefaultLayer(),p=this.layer?this.layer:this.map.getDefaultLayer();p.addOverlay(this.searchCircle);var c=new NPMapLib.Geometry.Size(76,24),u=OpenLayers.Util.getImageLocation("editCircle.png"),m=new NPMapLib.Symbols.Icon(u,c);this.editMarker=new NPMapLib.Symbols.Marker(t),this.editMarker.setIcon(m),this.editMarker.setOffset(new NPMapLib.Geometry.Size(20,(-12)));var d=new NPMapLib.Symbols.Label(s+n,{offset:new NPMapLib.Geometry.Size((-2),(-12))});d.setStyle({fontSize:12,fontFamily:"宋体",align:"left"}),this.editMarker.setLabel(d);var _=this.searchCircle.getCenter();_.lon=_.lon+(new NPMapLib.GisToolKit).getDistanceByProjection(s,this.map),this.editMarker.setPosition(_),this.map.enableEditing(),this.editMarker.enableEditing(),this.editMarker.isEnableEdit=!0,h.addOverlay(this.editMarker),this.editMarker.addEventListener("featuremousedown",function(t){y=!0,M=!0});var y=!1,M=!1,v=!1;this.editMarker.addEventListener("mouseover",function(t){v||(o.map.enableEditing(),v=!0),M=!0}),this.editMarker.addEventListener("mouseout",function(t){y||v&&(o.map.disableEditing(),v=!1),M=!1});var f=new NPMapLib.GisToolKit;this.editMarker.addEventListener("draging",function(t){var e=o.searchCircle.getCenter(),r=t.getPosition().lon-o.searchCircle.getCenter().lon;r=(new NPMapLib.GisToolKit).getPlatDistanceByProjection(r,o.map),r<a?(e.lon=e.lon+f.getDistanceByProjection(a,o.map),r=a):r>i?(e.lon=e.lon+f.getDistanceByProjection(i,o.map),r=i):e.lon=t.getPosition().lon;var s=t.getLabel();s.setContent(Math.round(r)+n),t.setLabel(s),o.searchCircle.setRadius(r),o.searchCircle.refresh(),t.setPosition(e),t.refresh()}),this.editMarker.addEventListener("dragend",function(t){M||v&&(o.map.disableEditing(),v=!1),l&&l instanceof Function&&l(o.searchCircle);var e=o.searchCircle.getExtent();o.map.zoomToExtent(e),y=!1}),this.map.disableEditing();var P=o.searchCircle.getExtent();this.map.zoomToExtent(P),l&&l instanceof Function&&l(o.searchCircle)},MapPlatForm.Base.MapTools.prototype.setCircleSearchControlRadius=function(t,e){if(this.searchCircle&&this.editMarker){var a="米";"EN"===NPMapLib.CULTURE&&(a="M");var i=this.searchCircle.getCenter();i.lon=i.lon+(new NPMapLib.GisToolKit).getDistanceByProjection(t,this.map),this.editMarker.setPosition(i),this.searchCircle.setRadius(t);var r=this.editMarker.getLabel();r.setContent(Math.round(t)+a),this.editMarker.setLabel(r),this.editMarker.refresh();var o=this.searchCircle.getExtent();this.map.zoomToExtent(o),e&&e instanceof Function&&e(self.searchCircle)}},MapPlatForm.Base.MapTools.prototype.removeCircleSearchControl=function(){this.editMarker&&(this.editMarker.removeEventListener("dragend"),this.editMarker.removeEventListener("draging"),this.editMarker.removeEventListener("mouseout"),this.editMarker.removeEventListener("mouseover"),this.editMarker.removeEventListener("featuremousedown"));var t=this.map.getDefaultLayer(),e=this.layer?this.layer:this.map.getDefaultLayer();t.removeOverlay(this.editMarker),e.removeOverlay(this.searchCircle),this.map.disableEditing()}}();